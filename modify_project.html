<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>新建项目</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      background-color: white;
      color: black;
      padding: 20px 20px;
      display: flex;
      align-items: center;
      justify-content: space-around;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .logo img {
      height: 50px;
    }

    .menu {
      display: flex;
      align-items: center;
    }

    .menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 20px;
    }

    .menu ul li {
      font-size: 18px;
    }

    .menu ul li a {
      text-decoration: none;
      color: black;
      padding: 5px 10px;
      border-radius: 5px;
    }
    
    .menu ul li a.active {
      background-color: #0073e6;
      color: white;
    }

    .profile {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .profile img {
      height: 40px;
      border-radius: 50%;
      margin-right: 120px;
    }

    .dropdown-menu {
        position: absolute;
        top: 70px;
        right: 190px;
        background-color: white;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        width: 140px;
        z-index: 9999;
        overflow: hidden;
    }

    .dropdown-menu a {
        display: block;
        padding: 10px 16px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
    }

    .dropdown-menu a:hover {
        background-color: #f0f0f0;
    }

    .dropdown-menu button.dropdown-link {
        display: block;
        width: 100%;
        padding: 10px 16px;
        border: none;
        background: none;
        text-align: left;
        font-size: 14px;
        color: #333;
        cursor: pointer;
    }

    .dropdown-menu button.dropdown-link:hover {
        background-color: #f0f0f0;
    }

    .page {
      display: none;
      max-width: 800px;
      margin: 60px auto;
      padding: 0 20px;
      font-size: 16px;
      line-height: 1.2;
      color: #000;
    }

    .page.active {
      display: block;
    }

    .page-title {
      text-align: center;
      font-size: 32px;
      margin: 50px 0;
    }

    .guidelines {
      margin-bottom: 40px;
    }

    .guidelines h2 {
      font-size: 22px;
      margin-top: 40px;
      font-weight: bold;
    }

    .guidelines ol {
      padding-left: 40px;
    }

    .guidelines li {
      margin-bottom: 10px;
      padding-left: 5px;
    }

    .project-form label {
      display: block;
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .project-form input[type="text"] {
      width: 100%;
      max-width: 800px;
      padding: 4px;
      font-size: 16px;
      margin-top: 10px;
    }

    .project-form textarea {
      width: 100%;
      max-width: 800px;
      padding: 4px;
      box-sizing: border-box;
      font-size: 16px;
      margin-top: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .language-header {
      display: flex;
      align-items: center;
      gap: 0px;
      margin-bottom: 10px;
    }

    .language-label {
      margin: 0;
      white-space: nowrap;
    }

    .language-group {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .language-group input {
      margin-right: 8px;
    }

    .language-group button {
      margin-left: 4px;
    }

    #addLanguageBtn {
      margin-left: 12px;
    }

    #language-container {
      margin-top: 10px;
      margin-bottom: 20px;
    }

    .remove-language {
      padding: 3px 8px;
      font-size: 14px;
      min-width: 60px;
      margin-top: auto;
    }

    .file-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
    }

    .file-actions .button {
      padding: 6px 12px;
      background-color: #ddd;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      color: #000;
      font-size: 14px;
    }

    .file-actions .button:hover {
      background-color: #bbb;
    }

    .form-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
    }

    .left-buttons,
    .right-buttons {
      display: flex;
      gap: 16px;
    }

    .nav-button {
      padding: 10px 20px;
      background-color: #0073e6;
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    .nav-button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    .page-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
    }

    .vocab-table-container {
      max-width: 1000px;
      margin: 40px auto;
    }

    .vocab-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .vocab-table-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .new-vocab-button {
      padding: 8px 14px;
      font-size: 14px;
      background-color: #0073e6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .vocab-table-wrapper {
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow-x: auto;
    }

    .vocab-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .vocab-table th,
    .vocab-table td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }

    .vocab-table thead {
      background-color: #f4f4f4;
    }

    #noVocabs {
      text-align: center;
      padding: 20px;
      color: #888;
    }

    .edit-button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .delete-button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .pagination-container {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      gap: 10px;
    }

    .page-btn {
      padding: 4px 12px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="img/EdUHK_logo.png" alt="香港教育大学 Logo">
    </div>

    <div style="width: 226px;"></div>

    <div class="profile">
      <img id="profileImg" src="img/profileImg.png" alt="头像">
    </div>

    <div id="dropdownMenu" class="dropdown-menu" style="display: none;">
      <a href="#">我的账户</a>
      <a href="projects.html">管理项目</a>
      <button class="dropdown-link" id="logoutBtn">退出登录</button>
    </div>
  </header>

  <div class="page active" id="info">
    <div class="page-title" id="infoPageTitle">新建项目</div>

    <div class="guidelines">
      <h2>贡献者要求：</h2>
      <ol>
        <li>具有目标语言词表，涵盖至少3个方言</li>
        <li>每个方言要求2000词以上</li>
        <li>谱系树</li>
      </ol>
    </div>

    <div class="project-form">
        <form id="projectForm">
          <label>项目ID：<input type="text" name="projectId" id="projectId" readonly></label><br><br>
          <label>项目名称：<input type="text" name="projectName" id="projectName" placeholder="请输入项目名称"></label><br><br>
          <label>项目简介：<br><textarea name="projectDesc" id="projectDesc" rows="4" cols="50" placeholder="请简要描述该项目的内容、目的或数据来源"></textarea></label><br><br>
      
          <label>项目类型：</label><br>
          <label><input type="radio" name="projectType" value="1"> 目标语言与其他语言的分化时间</label><br>
          <label><input type="radio" name="projectType" value="2"> 多个目标语言的分化时间</label><br>
          <label><input type="radio" name="projectType" value="3"> 目标语言的不同方言的分化时间</label><br><br>

          <div class="form-group language-header">
            <label for="language-container" class="language-label">语言列表：</label>
            <button type="button" id="addLanguageBtn">添加语言</button>
          </div>
          
          <div id="language-container"></div>

          <div class="form-group">
            <label for="treeFile">谱系树：</label>
            <input type="file" id="treeFile" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.txt">
            <div id="treeFileActions" class="file-actions" style="display: none;">
              <button type="button" id="viewTreeFile">查看</button>
              <button type="button" id="removeTreeFile">删除</button>
            </div>
          </div>
          
          <label>参考文献：<input type="text" name="references" id="references" placeholder="请输入参考资料链接或数据来源"></label><br><br>
      
          <div class="form-buttons">
            <div class="left-buttons">
                <button type="button" class="nav-button" id="leftBtn" onclick="saveDraft()">保存草稿</button>
                <button type="button" class="nav-button" id="leftBtn" onclick="returnPage()">返回</button>
            </div>
            <div class="right-buttons">
                <button type="button" class="nav-button"id="rightBtn" onclick="showPage(1)">下一页</button>
            </div>
          </div>
        </form>
      </div>
  </div>

  <div class="page" id="vocab">
    <div class="page-title" id="vocabPageTitle">新建项目</div>

    <div class="guidelines">
      <h2>注意事项：</h2>
      <ol>
        <li>什么是自带时间信息的词：XX、XX、XX……</li>
        <li>什么词汇不适合用作证据：XX、XX、XX……</li>
        <li>用于断代的时间参考有哪些：XX、XX、XX……</li>
        <li>时间的上限和下限的确定：XX……</li>
        <li>需将词汇分为不同的历史层次：早期、中期、后期</li>
        <li>不要使用具有多义的固有词</li>
      </ol>
    </div>

    <div class="project-form">
      <form id="projectForm">
        <div class="vocab-table-container">
          <div class="vocab-table-header">
            <h2 id="vocabListTitle">词汇列表</h2>
            <button type="button" class="new-vocab-button" id="addVocabBtn">添加词汇</button>
          </div>
          
          <div class="vocab-table-wrapper">
            <table class="vocab-table" id="vocabTable">
              <thead>
                <tr>
                  <th>词项</th>
                  <th>历史层次</th>
                  <th>完全普遍对应</th>
                  <th>不完全普遍对应</th>
                  <th>放宽的完全普遍对应</th>
                  <th>时间信息</th>
                  <th>证据词汇</th>
                  <th>录入时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="vocabBody">
              </tbody>
            </table>

            <div id="noVocabs">暂无词汇</div>
          </div>
        </div>

        <div class="pagination-container">
          <button type="button" id="prevVocabPage" class="page-btn">←</button>
          <span id="pageIndicator">第 1 页</span>
          <button type="button" id="nextVocabPage" class="page-btn">→</button>
        </div>
        
        <div class="page-buttons">
          <div class="left-buttons">
            <button type="button" class="nav-button" id="leftBtn" onclick="saveDraft()">保存草稿</button>
            <button type="button" class="nav-button" id="leftBtn" onclick="returnPage()">返回</button>
          </div>
          <div class="right-buttons">
            <button type="button" class="nav-button" onclick="showPage(0)">上一页</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="page" id="page1">
    <div class="page-title">词汇选择</div>

    <div class="form-group">
      <label><strong>类别：</strong></label><br>
      <div id="categoryGroup">
        <label><input type="radio" name="category" value="工具质料"> 工具质料</label><br>
        <label><input type="radio" name="category" value="禾谷类作物"> 禾谷类作物</label><br>
        <label><input type="radio" name="category" value="蔬菜"> 蔬菜</label><br>
        <label><input type="radio" name="category" value="水果"> 水果</label><br>
        <label><input type="radio" name="category" value="家畜"> 家畜</label><br>
        <label><input type="radio" name="category" value="外来文化概念"> 外来文化概念</label>
      </div>
    </div>
    
    <div class="form-group">
      <label><strong>词表：</strong></label><br>
      <div id="wordListGroup">
      </div>
    </div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button" onclick="saveVocab()">保存并返回</button>
        <button type="button" class="nav-button" onclick="showPage(1)">返回</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>

  <div class="page" id="page2">
    <div class="page-title">词汇输入</div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>
  <div class="page" id="page3">
    <div class="page-title">词汇比较</div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>
  <div class="page" id="page4">
    <div class="page-title">历史层级</div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>
  
  <div class="page" id="page5">
    <div class="page-title">对应情况</div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>

  <div class="page" id="page6">
    <div class="page-title">可释性与同源性</div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>

  <div class="page" id="page7">
    <div class="page-title">时间信息</div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn" id="endPage">下一页</button>
      </div>
    </div>
  </div>
</body>

<script>
    let currentPage = 0;
    const totalPages = 8;

    let currentVocabPage = 1;
    const pageSize = 5;
    let totalVocabPages = 1;

    let isTreeFileRemoved = false;

    let vocabData = [];
    let editingVocabIndex = null;

    let originalDraft = null;

    function updateRemoveButtons() {
      const removeBtns = document.querySelectorAll(".remove-language");
      removeBtns.forEach(btn => btn.style.display = (languageContainer.children.length > 2 ? "inline-block" : "none"));
    }

    function addLanguageInput(value = "") {
      if (languageContainer.children.length >= 6) {
        alert("最多只能添加6种语言");
        return;
      }
      const div = document.createElement("div");
      div.className = "language-group";
      div.innerHTML = `
        <input type="text" class="language-input" placeholder="输入语言名称" value="${value}">
        <button type="button" class="remove-language">移除</button>
      `;
      languageContainer.appendChild(div);
      updateRemoveButtons();

      div.querySelector(".remove-language").addEventListener("click", () => {
        div.remove();
        updateRemoveButtons();
      });
    }
    window.addLanguageInput = addLanguageInput;

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      let projectId = urlParams.get("id");

      document.querySelector(".page-buttons").style.display = "none";

      if (!projectId) {
        const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
        const ids = drafts.map(d => d.id).filter(Boolean);
        let maxNum = 0;
        ids.forEach(id => {
          const match = id.match(/proj_(\\d+)/);
          if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNum) maxNum = num;
          }
        });
        projectId = `proj_${maxNum + 1}`;
        sessionStorage.setItem("editingProjectId", projectId);
      }

      document.getElementById("projectId").value = projectId;

      const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
      const existing = drafts.find(p => p.id === projectId);

      const treeFileInput = document.getElementById("treeFile");
      const viewTreeFile = document.getElementById("viewTreeFile");
      const removeTreeFile = document.getElementById("removeTreeFile");
      const treeFileActions = document.getElementById("treeFileActions");

      if (existing) {
        document.getElementById("infoPageTitle").textContent = "编辑项目";
        document.getElementById("vocabPageTitle").textContent = "编辑项目";
        document.getElementById("projectName").value = existing.projectName || "未命名项目";
        document.getElementById("projectDesc").value = existing.projectDesc || "";
        document.getElementById("references").value = existing.references || "";
        originalDraft = JSON.stringify(existing);

        if (existing && existing.projectName) {
          document.title = existing.projectName;
        } else {
          document.title = "新建项目";
        }

        if (existing.projectType) {
          const radio = document.querySelector(`input[name=\"projectType\"][value=\"${existing.projectType}\"]`);
          if (radio) radio.checked = true;
        }
        if (existing?.treeFile && !isTreeFileRemoved) {
          const blob = base64ToBlob(existing.treeFile.content.split(",")[1], existing.treeFile.type);
          const url = URL.createObjectURL(blob);
          viewTreeFile.href = url;
          viewTreeFile.download = existing.treeFile.name;
          treeFileActions.style.display = "flex";
          document.getElementById("treeFileActions").style.display = "flex";

          localStorage.setItem("tempTreeFileBase64", existing.treeFile.content.split(",")[1]);
          localStorage.setItem("tempTreeFileName", existing.treeFile.name);
          localStorage.setItem("tempTreeFileType", existing.treeFile.type);
        }

        vocabData = existing.vocabList || [];
        loadVocabList(vocabData);
      }

      languageContainer = document.getElementById("language-container");
      window.languageContainer = languageContainer;

      if (existing?.languages && Array.isArray(existing.languages)) {
        existing.languages.forEach(name => addLanguageInput(name));
        const missingCount = 2 - existing.languages.length;
        for (let i = 0; i < missingCount; i++) {
          addLanguageInput();
        }
      } else {
        addLanguageInput();
        addLanguageInput();
      }

      document.getElementById("addLanguageBtn").addEventListener("click", () => addLanguageInput());

      document.getElementById("viewTreeFile").addEventListener("click", () => {
        const base64 = localStorage.getItem("tempTreeFileBase64");
        const type = localStorage.getItem("tempTreeFileType");
        if (base64 && type) {
          const blob = base64ToBlob(base64, type);
          const url = URL.createObjectURL(blob);
          window.open(url, "_blank");
        }
      });

      function base64ToBlob(base64, type) {
        const binary = atob(base64);
        const array = [];
        for (let i = 0; i < binary.length; i++) {
          array.push(binary.charCodeAt(i));
        }
        return new Blob([new Uint8Array(array)], { type: type });
      }

      treeFileInput.addEventListener("change", () => {
        const file = treeFileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const base64 = e.target.result.split(',')[1];

          localStorage.setItem("tempTreeFileBase64", base64);
          localStorage.setItem("tempTreeFileName", file.name);
          localStorage.setItem("tempTreeFileType", file.type);

          const blob = base64ToBlob(base64, file.type);
          const url = URL.createObjectURL(blob);

          viewTreeFile.href = url;
          viewTreeFile.download = file.name;
          treeFileActions.style.display = "flex";
        };
        
        reader.readAsDataURL(file);
      });

      removeTreeFile.addEventListener("click", () => {
        localStorage.removeItem("tempTreeFileBase64");
        localStorage.removeItem("tempTreeFileName");
        localStorage.removeItem("tempTreeFileType");

        treeFileInput.value = "";
        viewTreeFile.removeAttribute("href");
        viewTreeFile.removeAttribute("download");

        treeFileActions.style.display = "none";
        isTreeFileRemoved = true;
      });

      window.deleteVocab = function(id) {
        if (confirm("确定要删除该词汇吗？")) {
          const index = vocabData.findIndex(item => item.id === id);
          if (index !== -1) {
            vocabData.splice(index, 1);
            loadVocabList(vocabData);
          }

          const totalAfterDelete = Math.ceil(vocabData.length / pageSize);
          if (currentVocabPage > totalAfterDelete) {
            currentVocabPage = Math.max(1, totalAfterDelete);
          }

            loadVocabList();
            alert("已删除词汇");
        }
      };

      document.getElementById("addVocabBtn").addEventListener("click", () => {
        editingVocabIndex = null;
        currentPage = 2;
        showPage(currentPage);

        document.querySelectorAll('input[name="category"]').forEach(r => r.checked = false);
        document.getElementById("wordListGroup").innerHTML = "";
      });

      const wordOptions = {
        "工具质料": ["石", "铜", "铁", "木", "骨", "牙", "金", "锡", "银"],
        "禾谷类作物": ["稻", "小麦", "玉米"],
        "蔬菜": ["白菜", "萝卜"],
        "水果": ["苹果", "梨"],
        "家畜": ["牛", "羊"],
        "外来文化概念": ["佛", "汉字", "钱币"]
      };

      document.querySelectorAll('input[name="category"]').forEach(radio => {
        radio.addEventListener('change', function () {
          const selectedCategory = this.value;
          const wordList = wordOptions[selectedCategory] || [];
          const wordListGroup = document.getElementById("wordListGroup");

          wordListGroup.innerHTML = wordList.map(word =>
            `<label><input type="radio" name="word" value="${word}"> ${word}</label><br>`
          ).join("");
        });
      });

      document.getElementById("prevVocabPage").addEventListener("click", () => {
        currentVocabPage--;
        loadVocabList();
      });

      document.getElementById("nextVocabPage").addEventListener("click", () => {
        currentVocabPage++;
        loadVocabList();
      });

      function setupProfileMenu() {
        const profileImg = document.getElementById("profileImg");
        const dropdown = document.getElementById("dropdownMenu");

        if (!profileImg || !dropdown) return;

        profileImg.onclick = () => {
            if (sessionStorage.getItem("isLoggedIn") === "true") {
              dropdown.style.display = (dropdown.style.display === "none") ? "block" : "none";
            } else {
              window.location.href = "language_map.html";
            }
        };

        document.addEventListener("click", (e) => {
            if (!profileImg.contains(e.target) && !dropdown.contains(e.target)) {
              dropdown.style.display = "none";
            }
        });
      }

      setupProfileMenu();

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          sessionStorage.removeItem("isLoggedIn");
          alert("已退出登录");
          location.reload();
        });
      }

      window.addEventListener("beforeunload", (e) => {
        if (isDraftModified()) {
          e.preventDefault();
          e.returnValue = "您有未保存的更改，确定要离开吗？";
        }
      });
    });

    function showPage(pageNum) {
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));

      let pageId = '';
      if (pageNum === 0) pageId = 'info';
      else if (pageNum === 1) pageId = 'vocab';
      else pageId = 'page' + (pageNum - 1);

      const pageEl = document.getElementById(pageId);
      if (pageEl) pageEl.classList.add('active');

      if (pageNum === 0) {
        currentPage = 0
        document.querySelector(".form-buttons").style.display = "flex";
        document.querySelector(".page-buttons").style.display = "none";
        return;
      } else if (pageNum === 1) {
        currentPage = 1;
        document.querySelector(".form-buttons").style.display = "none";
        document.querySelector(".page-buttons").style.display = "flex";
        return;
      } else {
        document.getElementById(pageId).classList.add('active');
        document.getElementById("endPage").disabled = true;
      }
    }

    document.querySelectorAll('.prevBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          showPage(currentPage);
        }
      });
    });

    document.querySelectorAll('.nextBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          showPage(currentPage);
        }
      });
    });

    function saveDraft() {
      const currentId = sessionStorage.getItem("editingProjectId");
      if (!currentId) return;

      const languageInputs = document.querySelectorAll(".language-input");
      const languages = Array.from(languageInputs).map(input => input.value.trim()).filter(Boolean);

      const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
      const existing = drafts.find(p => p.id === currentId);

      const projectName = document.getElementById("projectName").value.trim();
      const projectDesc = document.getElementById("projectDesc").value.trim();
      const references = document.getElementById("references").value.trim();
      const projectType = document.querySelector('input[name="projectType"]:checked')?.value || null;

      const base64 = localStorage.getItem("tempTreeFileBase64");
      const name = localStorage.getItem("tempTreeFileName");
      const type = localStorage.getItem("tempTreeFileType");

      const treeFile = document.getElementById("treeFile").files[0];
      const treeFileObj = base64 ? {
        name: name,
        type: type,
        content: `data:${type};base64,${base64}`
      } : existing?.treeFile || null;

      function finalizeSave(treeFileObj) {
        const draft = {
          id: currentId,
          projectName,
          projectDesc,
          references,
          projectType,
          languages,
          createdAt: existing?.createdAt || new Date().toLocaleString(),
          treeFile: isTreeFileRemoved ? null : (treeFileObj || existing?.treeFile || null),
          vocabList: vocabData,
        };

        const index = drafts.findIndex(p => p.id === currentId);
        if (index !== -1) {
          drafts[index] = draft;
        } else {
          drafts.push(draft);
        }

        localStorage.setItem("projectDrafts", JSON.stringify(drafts));
        if (currentPage <= 1) alert("草稿已保存！");
      }

      if (treeFile) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const treeFileObj = {
            name: treeFile.name,
            type: treeFile.type,
            content: e.target.result
          };
          finalizeSave(treeFileObj);
        };
        reader.readAsDataURL(treeFile);
      } else {
        finalizeSave(null);
      }
    };

    window.saveDraft = saveDraft;

    function loadVocabList(vocabList) {
      const tbody = document.getElementById("vocabBody");
      const noVocabs = document.getElementById("noVocabs");

      const totalVocabPages = Math.ceil(vocabData.length / pageSize);
      const start = (currentVocabPage - 1) * pageSize;

      tbody.innerHTML = "";

      if (vocabData.length === 0) {
        noVocabs.style.display = "block";
        return;
      }

      noVocabs.style.display = "none";

      vocabData.slice(start, start + pageSize).forEach((item, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${item.word || "--"}</td>
          <td>--</td>
          <td>Y/N</td>
          <td>Y/N</td>
          <td>Y/N</td>
          <td>${item.time || "--"}</td>
          <td>${item.evidence || "--"}</td>
          <td>${item.recordedAt || "--"}</td>
          <td>
            <button type="button" class="edit-button" data-id="${item.id}">编辑</button>
            <button type="button" class="delete-button" onclick="deleteVocab(${item.id})">删除</button>
          </td>
        `;

        tbody.appendChild(row);

        document.getElementById("vocabListTitle").textContent = `词汇列表（已有 ${vocabData.length} 个词汇）`;

        const editBtn = row.querySelector(".edit-button");
        editBtn.addEventListener("click", () => {
          const vocabId = parseInt(editBtn.getAttribute("data-id"));
          const vocab = vocabData.find(item => item.id === vocabId);
          editingVocabIndex = vocabData.findIndex(item => item.id === vocabId);
          currentPage = 2;
          showPage(currentPage);

          if (vocab) {
            const catRadio = document.querySelector(`input[name="category"][value="${vocab.category}"]`);
            if (catRadio) {
              catRadio.checked = true;
              catRadio.dispatchEvent(new Event('change'));

              const observer = new MutationObserver(() => {
                const wordRadio = document.querySelector(`input[name="word"][value="${vocab.word}"]`);
                if (wordRadio) {
                  wordRadio.checked = true;
                  observer.disconnect();
                }
              });

              observer.observe(document.getElementById("wordListGroup"), {
                childList: true,
                subtree: true,
              });

              setTimeout(() => {
                const wordRadio = document.querySelector(`input[name="word"][value="${vocab.word}"]`);
                if (wordRadio) {
                  wordRadio.checked = true;
                }
              }, 50);
            }
          }
        });
      });

      document.getElementById("pageIndicator").textContent = `第 ${currentVocabPage} 页`;
      document.getElementById("prevVocabPage").style.display = (currentVocabPage > 1) ? "inline-block" : "none";
      document.getElementById("nextVocabPage").style.display = (currentVocabPage < totalVocabPages) ? "inline-block" : "none";
      document.querySelector(".pagination-container").style.display = (totalVocabPages > 1) ? "flex" : "none";
    }

    window.loadVocabList = loadVocabList;

    function saveVocab() {
      const category = document.querySelector('input[name="category"]:checked')?.value;
      const word = document.querySelector('input[name="word"]:checked')?.value;

      if (!category || !word) {
        alert("请选择类别和词汇");
        return;
      }

      const vocabEntry = {
        id: editingVocabIndex === null
          ? (vocabData.length > 0 ? Math.max(...vocabData.map(v => v.id)) + 1 : 1)
          : vocabData[editingVocabIndex].id,
        category,
        word,
        level: "",
        fullMatch: false,
        partialMatch: false,
        relaxedMatch: false,
        time: "",
        evidence: "",
        recordedAt: editingVocabIndex === null 
          ? new Date().toLocaleString()
          : vocabData[editingVocabIndex].recordedAt,
      };

      if (editingVocabIndex !== null) {
        vocabData[editingVocabIndex] = vocabEntry;
      } else {
        vocabData.push(vocabEntry);
      }

      saveDraft();
      showPage(1);
      loadVocabList(vocabData);
    }

    function isDraftModified() {
      const currentId = sessionStorage.getItem("editingProjectId");
      const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
      const currentDraft = drafts.find(p => p.id === currentId);
      if (!originalDraft || !currentDraft) return false;

      return originalDraft !== JSON.stringify(currentDraft);
    }

    function returnPage() {
      if (isDraftModified()) {
        if (confirm("您有未保存的更改，确定要离开吗？")) {
          window.location.href = "projects.html";
        }
      } else window.location.href = "projects.html";
    }
</script>

</html>