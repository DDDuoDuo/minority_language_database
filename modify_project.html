<html lang="zh">
<head>
  <link rel="stylesheet" href="auth.css">
  <script src="auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <meta charset="UTF-8">
  <title>新建项目</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    header {
      background-color: white;
      color: black;
      padding: 20px 20px;
      display: flex;
      align-items: center;
      justify-content: space-around;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .logo img {
      height: 50px;
    }

    .menu {
      display: flex;
      align-items: center;
    }

    .menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 20px;
    }

    .menu ul li {
      font-size: 18px;
    }

    .menu ul li a {
      text-decoration: none;
      color: black;
      padding: 5px 10px;
      border-radius: 5px;
    }
    
    .menu ul li a.active {
      background-color: #0073e6;
      color: white;
    }

    .profile {
      display: flex;
      align-items: center;
      margin-right: 75px;
      gap: 16px;
      cursor: pointer;
    }
    
    .profile img {
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }

    .profile-name {
      color: gray;
      font-size: 16px;
      user-select: none;
    }

    .dropdown-menu {
      position: absolute;
      top: 70px;
      right: 190px;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      width: 140px;
      z-index: 9999;
      overflow: hidden;
    }

    .dropdown-menu a {
      display: block;
      padding: 10px 16px;
      text-decoration: none;
      color: #333;
      font-size: 14px;
    }

    .dropdown-menu a:hover {
      background-color: #f0f0f0;
    }

    .dropdown-menu button.dropdown-link {
      display: block;
      width: 100%;
      padding: 10px 16px;
      border: none;
      background: none;
      text-align: left;
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }

    .dropdown-menu button.dropdown-link:hover {
      background-color: #f0f0f0;
    }

    .page {
      display: none;
      max-width: 800px;
      margin: 60px auto;
      padding: 0 20px;
      font-size: 16px;
      line-height: 1.2;
      color: #000;
    }

    .page.active {
      display: block;
    }

    .page-title {
      text-align: center;
      font-size: 32px;
      margin: 50px 0;
    }

    .guidelines {
      margin-bottom: 40px;
      line-height: 1.8;
    }

    .guidelines h2 {
      font-size: 22px;
      margin-top: 40px;
      font-weight: bold;
    }

    .guidelines ol {
      padding-left: 40px;
    }

    .guidelines li {
      margin-bottom: 10px;
      padding-left: 5px;
    }

    .project-form label {
      display: block;
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .project-form input[type="text"]:not(.coord-input) {
      width: 100%;
      max-width: 800px;
      padding: 4px;
      font-size: 16px;
      margin-top: 10px;
    }

    .project-form textarea {
      width: 100%;
      max-width: 800px;
      padding: 4px;
      box-sizing: border-box;
      font-size: 16px;
      margin-top: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .language-header {
      display: flex;
      align-items: center;
      gap: 0px;
      margin-bottom: 10px;
    }

    .language-label {
      margin: 0;
      white-space: nowrap;
    }

    .language-group {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .language-group input {
      margin-right: 8px;
    }

    .language-group button {
      margin-left: 4px;
    }

    #addLanguageBtn {
      margin-left: 12px;
    }

    #language-container {
      margin-top: 10px;
      margin-bottom: 20px;
    }
    
    .coord-input {
      width: 80px;
      max-width: 800px;
      padding: 4px;
      font-size: 16px;
      margin-top: 10px;
    }

    .remove-language {
      padding: 3px 8px;
      font-size: 14px;
      min-width: 60px;
      margin-top: auto;
    }

    .file-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
    }

    .file-actions .button {
      padding: 6px 12px;
      background-color: #ddd;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      color: #000;
      font-size: 14px;
    }

    .file-actions .button:hover {
      background-color: #bbb;
    }

    .form-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }

    .left-buttons,
    .right-buttons {
      display: flex;
      gap: 16px;
    }

    .nav-button {
      padding: 10px 20px;
      background-color: #0073e6;
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }

    .nav-button:hover {
      background: #1a5edb;
    }

    .nav-button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }

    .page-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
    }

    .vocab-table-container {
      max-width: 1000px;
      margin: 40px auto;
    }

    .vocab-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .vocab-table-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .vocab-table-header-left {
      display: flex;
    }

    .vocab-table-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .new-vocab-button {
      padding: 8px 14px;
      font-size: 14px;
      background-color: #0073e6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .new-vocab-button:hover {
      background: #1a5edb;
    }

    .vocab-table-wrapper {
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 60vh;
      overflow: auto;
    }

    .vocab-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .match-title {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .match-section {
      margin-top: 16px;
    }

    .radio-row {
      display: flex;
      align-items: center;
      margin: 10px 0;
      margin-top: 16px;
    }

    .radio-label {
      display: inline-flex;
      flex: 0 0 240px;
      font-weight: 600;
    }

    .radio-options {
      display: flex;
      gap: 40px;
    }

    .radio-options label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sub-note {
      margin-top: 12px;
      color: #666;
      font-size: 12px;
    }

    .help-tip {
      position: relative;
      display: inline-block;
      width: 18px;
      height: 18px;
      cursor: help;
    }

    .help-tip img {
      width: 18px;
      height: 18px;
      display: block;
    }

    .tooltip {
      position: absolute;
      top: 120%;
      left: 0;
      min-width: 260px;
      max-width: 420px;
      background: rgba(51, 51, 51, 0.8);
      color: #fff;
      font-size: 12px;
      line-height: 1.5;
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
      display: none;
      z-index: 10;
    }

    .help-tip:hover .tooltip {
      display: block;
    }

    .match-options,
    .relaxed-options {
      margin-top: 16px;
    }

    .time-range-section {
      margin-top: 16px;
    }

    .time-range-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .time-sentence {
      line-height: 1.6;
    }

    .time-inline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .time-input {
      width: 90px;
      padding: 6px 10px;
    }

    .time-input[readonly] {
      border: 1px solid #ccc;
      outline: none;
      background: #fff;
      color: #333;
    }
    
    .era-label {
      padding: 6px 10px;
      display: inline-block;
    }

    .time-select {
      padding: 6px 10px;
    }

    .hidden {
      display: none;
    }

    .readonly-dialect {
      color: #333;
      user-select: none;
    }

    .vocab-table input {
      width: 100%;
      box-sizing: border-box;
    }

    .vocab-table th,
    .vocab-table td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }

    .vocab-table thead {
      background-color: #f4f4f4;
    }

    #noVocabs {
      text-align: center;
      padding: 20px;
      color: #888;
    }

    .edit-button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .delete-button {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .dialect-form-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dialect-form-cell .syllable-input {
      flex: 1;
      min-width: 0;
    }

    .compare-readonly {
      color: #333;
      user-select: none;
    }

    .compare-select, .compare-input {
      width: 100%;
      box-sizing: border-box;
    }

    .feature-options {
      flex-direction: row;
      align-items: center;
      gap: 16px;
    }
    
    .feature-options label {
      display: inline-flex;
      align-items: center;
      white-space: nowrap;
      font-size: 16px;
      gap: 4px;
    }

    .hint-text {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    .pagination-container {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 16px;
      gap: 10px;
    }

    .page-btn {
      padding: 4px 12px;
      font-size: 16px;
      cursor: pointer;
    }

    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      z-index: 9998;
    }

    .modal {
      position: fixed; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: min(1200px, 92vw);
      max-height: 90vh;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.2);
      z-index: 9999;
      display: flex; 
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 14px 16px; 
      border-bottom: 1px solid #eee;
    }
    
    .modal-close {
      background: none; 
      border: none; 
      font-size: 22px; 
      cursor: pointer;
      line-height: 1; 
      padding: 4px 8px;
    }

    .modal-body {
      padding: 16px;
      flex: 1;
      min-height: 0;
      max-height: 90vh;
      overflow-y: auto;
      padding-bottom: 18px;
    }

    body.modal-open {
      overflow: hidden; 
    }

    .ref-table {
      table-layout: fixed;
      font-size: 11px;
      border-collapse: collapse;
      width: 100%;
    }

    .ref-table th,
    .ref-table td {
      padding: 4px 6px;
      line-height: 1.3;
      vertical-align: top;
      word-break: break-word;
      border-bottom: 1px solid #ccc;
    }

    .ref-table thead {
      background-color: #f4f4f4;
    }

    .ref-table-wrapper {
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 40vh;
      margin-bottom: 20px;
      overflow: auto;
    }

    .table-wrap { 
      overflow: auto;
    }

    .table-title { 
      margin: 8px 0; 
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="img/EdUHK_logo.png" alt="香港教育大学 Logo">
    </div>

    <div style="width: 226px;"></div>

    <div class="profile" id="profile">
      <img id="profileImg" src="img/profile.png" alt="头像">
      <span class="profile-name" id="userStatus">登录</span>
    </div>

    <div id="dropdownMenu" class="dropdown-menu" style="display: none;">
      <a href="account.html">我的账户</a>
      <a href="projects.html">管理项目</a>
      <button class="dropdown-link" id="logoutBtn">退出登录</button>
    </div>
  </header>

  <div class="page active" id="info">
    <div class="page-title" id="infoPageTitle">新建项目</div>

    <div class="guidelines">
      <h2>贡献者要求：</h2>
      <ol>
        <li>具有目标语言或者方言的比较词汇</li>
        <li>包括至少2个目标语言或者方言</li>
        <li>每个语言或者方言要求有2000词或者以上词表</li>
        <li>需有一棵覆盖目标语言或者方言的参考谱系树</li>
      </ol>
    </div>

    <div class="project-form">
        <form id="projectForm">
          <label>项目ID：<input type="text" name="projectId" id="projectId" readonly></label><br><br>
          <label>项目名称：<input type="text" name="projectName" id="projectName" placeholder="请输入项目名称"></label><br><br>
          <label>项目简介：<br><textarea name="projectDesc" id="projectDesc" rows="4" cols="50" placeholder="请简要描述该项目的内容、目的或数据来源"></textarea></label><br><br>
      
          <label>项目类型：</label><br>
          <label><input type="radio" name="projectType" value="1"> 目标语言与其他语言的分化时间</label><br>
          <label><input type="radio" name="projectType" value="2"> 多个目标语言的分化时间</label><br>
          <label><input type="radio" name="projectType" value="3"> 目标语言的不同方言的分化时间</label><br><br>

          <div class="form-group language-header">
            <label for="language-container" class="language-label">语言列表：</label>
            <button type="button" class="new-vocab-button" id="addLanguageBtn">添加语言</button>
          </div>
          
          <div id="language-container"></div>

          <div class="form-group">
            <label for="treeFile">谱系树：</label>
            <input type="file" id="treeFile" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.txt">
            <div id="treeFileActions" class="file-actions" style="display: none;">
              <button type="button" id="viewTreeFile">查看</button>
              <button type="button" id="removeTreeFile">删除</button>
            </div>
          </div>
          
          <label>参考文献：<input type="text" name="references" id="references" placeholder="请输入参考资料链接或数据来源"></label><br><br>
          
          <div class="form-buttons">
            <div class="left-buttons">
              <button disabled type="button" class="nav-button" id="leftBtn">上一页</button>
            </div>
            <div class="right-buttons">
                <button type="button" class="nav-button" id="rightBtn" onclick="showPage(1)">下一页</button>
            </div>
          </div>

          <div class="form-buttons">
            <div class="left-buttons">
                <button type="button" class="nav-button" id="leftBtn" onclick="saveDraft()">保存草稿</button>
                <button type="button" class="nav-button" id="leftBtn" onclick="window.location.href = 'projects.html'">返回</button>
            </div>
          </div>
        </form>
      </div>
  </div>

  <div class="page" id="vocab">
    <div class="page-title" id="vocabPageTitle">新建项目</div>

    <div class="guidelines">
      <h2>注意事项：</h2>
      <ol>
        <li><strong><u>如何选择自带信息的词</u>：A. 新概念词：</strong>反映人类文明发展节点（如石铜铁的使用、作物引进等），
          其产生/传播时间可通过考古学和历史学确定，这类词汇如同语言中的"时间胶囊"，
          为语言演变研究提供客观的年代参照系。<strong>B. 借词：</strong>通过有记录的音韵特征可追溯借入年代，特别是汉语借词、藏语借词、缅语借词等。</li>
        <li><strong><u>不适合用作证据的词</u>：</strong>用固有概念表达新概念的情况，如四川彝语用<strong>花椒（固有词）</strong>表达<strong>辣椒（外来物种）</strong>，但发生了词汇创新的情况例外。</li>
        <li><strong><u>用于断代的时间参考</u>：</strong>本数据库根据文献资料提供了一些时间参考，贡献者可以根据自己对时间上下限更精准的掌握进行调整。可供参考的时间包括：
          <strong>上古汉语（1556 BC - 266）、中古汉语（266 - 1279）、近代汉语（1279 - 1912）、现代汉语 (1912以后)；或者中国朝代断代。</strong></li>
        <li><strong><u>需将词汇分为不同的历史层次</u>：早期、中期、后期。</strong>贡献者可根据词汇所处的具体历史时期进行归类，核心原则是确保各层次间的相对时间顺序正确。
          例如：前汉时期词汇（公元前-220年）、唐宋时期词汇（618-1279年）、明清时期词汇（1368-1912年）、或者两汉六朝时期词汇（公元前202年 - 公元589年）、
          初唐时期词汇（公元618年 – 约公元712年）、晚唐初宋词汇（约公元836年 – 约公元1000年）。</li>
        <li><strong><u>时间的上限和下限的确定</u>：</strong>寻找能证明某个现象在某个区域已经存在的最早的确凿证据、寻找能证明某个现象在某个区域仍然存在或开始消失的最晚的确凿证据。</li>
      </ol>
    </div>

    <div class="project-form">
      <form id="projectForm">
        <div class="vocab-table-container">
          <div class="vocab-table-header">
            <h2 id="vocabListTitle">词汇列表</h2>
            <div class="vocab-table-header-right">
              <button type="button" class="new-vocab-button" id="exportVocabTableBtn">导出语言分化信息</button>
              <button type="button" class="new-vocab-button" id="exportAllVocabsBtn">导出全部录入词汇</button>
              <button type="button" class="new-vocab-button" id="addVocabBtn">添加词汇</button>
            </div>
          </div>
          
          <div class="vocab-table-wrapper">
            <table class="vocab-table" id="vocabTable">
              <thead>
                <tr>
                  <th>词项</th>
                  <th>历史层次</th>
                  <th>完全普遍对应</th>
                  <th>不完全普遍对应</th>
                  <th>放宽的完全普遍对应</th>
                  <th>时间信息</th>
                  <th>证据词汇</th>
                  <th>录入时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="vocabBody">
              </tbody>
            </table>

            <div id="noVocabs">暂无词汇</div>
          </div>
          <div class="hint-text">*当“放宽的完全普遍对应”显示为“Y”时，可能可以认为也属于“完全普遍对应”，即目标语言没有分化</div>
        </div>

        <div class="form-group time-range-section" id="projectTimeSection">
          <div class="time-range-title">根据录入的时间信息，请确定本项目中目标语言的分化时间：</div>

          <div class="time-sentence">
            目标语言分化时间为 上限
            <span class="time-inline">
              <input type="number" id="projectTimeUpper" class="time-input" placeholder="年份">
              <span id="projectTimeUpperEra" class="era-label"></span>
            </span>
            至 下限
            <span class="time-inline">
              <input type="number" id="projectTimeLower" class="time-input" placeholder="年份">
              <span id="projectTimeLowerEra" class="era-label"></span>
            </span>
          </div>

          <div class="hint-text">*时间范围由系统自动确定，上限取最近的上限时间，下限取最早的下限时间</div>
        </div>

        <div class="pagination-container">
          <button type="button" id="prevVocabPage" class="page-btn">←</button>
          <span id="pageIndicator">第 1 页</span>
          <button type="button" id="nextVocabPage" class="page-btn">→</button>
        </div>

        <div class="form-buttons">
          <div class="left-buttons">
            <button type="button" class="nav-button" id="leftBtn" onclick="showPage(0)">上一页</button>
          </div>
          <div class="right-buttons">
              <button disabled type="button" class="nav-button"id="rightBtn">下一页</button>
          </div>
        </div>
        
        <div class="form-buttons">
          <div class="left-buttons">
            <button type="button" class="nav-button" id="leftBtn" onclick="saveDraft()">保存草稿</button>
            <button type="button" class="nav-button" id="leftBtn" onclick="window.location.href = 'projects.html'">返回</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="page" id="page1">
    <div class="page-title">词汇选择</div>

    <div class="form-group">
      <label><strong>类别：</strong></label><br>
      <div id="categoryGroup">
        <label><input type="radio" name="category" value="工具质料"> 工具质料</label><br>
        <label><input type="radio" name="category" value="禾谷类作物"> 禾谷类作物</label><br>
        <label><input type="radio" name="category" value="蔬菜"> 蔬菜</label><br>
        <label><input type="radio" name="category" value="水果"> 水果</label><br>
        <label><input type="radio" name="category" value="家畜"> 家畜</label><br>
        <label><input type="radio" name="category" value="外来文化概念"> 外来文化概念</label><br>
        <label><input type="radio" name="category" value="其他"> 其他</label>
      </div>
    </div>
    
    <div class="form-group">
      <label><strong>词表：</strong></label><br>
      <div id="wordSelectHost">
        <select id="wordSelect">
          <option value="">请选择词汇</option>
        </select>
      </div>
    </div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button" onclick="saveVocab()">保存并返回</button>
        <button type="button" class="nav-button" onclick="showPage(1)">返回</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>
  </div>

  <div class="page" id="page2">
    <div class="page-title">词汇输入</div>

    <div class="form-group">
      <div class="vocab-table-header">
        <div class="vocab-table-header-left">
          <h2>当前词汇：</h2>
          <h2 id="currentWordDisplay">暂无词汇</h2>
        </div>

        <button type="button" class="new-vocab-button" id="addColumnBtn">添加方言</button>
      </div>
    
      <div class="vocab-table-wrapper">
        <table class="vocab-table" id="wordTable">
          <thead>
            <tr>
              <th>方言名称</th>
              <th>音节</th>
            </tr>
          </thead>
          <tbody id="wordBody">
          </tbody>
        </table>
      </div>
      <div class="hint-text" id="wordHint"></div>

      <br>

      <div class="form-group match-section" id="matchSection">
        <div class="match-title">
          <span>请判断该词汇的对应情况</span>
          <span class="help-tip" aria-label="help">
            <img src="img/question.png" alt="问号">
            <span class="tooltip">
              完全对应与普遍对应严格界定为：词汇所有音节在声母、韵母以及声调系统层面跨语言的规律性音韵对应，而非表层语音形式的偶然相似。
            </span>
          </span>
        </div>

        <div class="match-options" id="matchOptions">
          <label>
            <input type="radio" name="matchType" value="full"> 完全对应和普遍对应
          </label>
          &emsp;
          <label>
            <input type="radio" name="matchType" value="partial"> 不完全对应或不普遍对应
          </label>

          <div id="fullNote" class="sub-note hidden">
            *完全对应和普遍对应说明该语言未分化
          </div>
        </div>

        <div class="relaxed-options hidden" id="relaxedOptions">
          <div class="match-title">
            <span>是否存在放宽的普遍对应</span>
          </div>
          <br><br>
          <label>
            <input type="radio" name="relaxedType" value="crossBranch">
            是，即在本词项上发生不完全对应的语言仅存在于谱系树的同一分支内，不同分支之间仍能形成完全和普遍对应
          </label>
          <br><br>
          <label>
            <input type="radio" name="relaxedType" value="branchOnly">
            否，即在本词项上发生不完全对应的语言不仅存在于谱系树的同一分支内，而且也存在于谱系树的不同分支内
          </label>

          <div id="relaxedNote" class="sub-note hidden">
            *这个词汇表示该语言已经全分化
          </div>
        </div>
      </div>
    </div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>

    <div class="form-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button" onclick="saveVocab()">保存并返回</button>
        <button type="button" class="nav-button" onclick="showPage(1)">返回</button>
      </div>
    </div>
  </div>

  <div class="page" id="page3">
    <div class="page-title">词汇比较</div>

    <div class="form-group">
      <div class="vocab-table-header">
        <h2>请提供对应证据</h2>
        <button type="button" class="new-vocab-button" id="addCompareRowBtn">添加一行</button>
      </div>
  
      <div class="vocab-table-wrapper">
        <table class="vocab-table" id="compareTable">
          <thead>
            <tr id="compareHeadRow">
            </tr>
          </thead>
          <tbody id="compareBody">
          </tbody>
        </table>
      </div>
      <div class="hint-text" id="compareHint"></div>
    </div>

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>

    <div class="form-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button" onclick="saveVocab()">保存并返回</button>
        <button type="button" class="nav-button" onclick="showPage(1)">返回</button>
      </div>
    </div>
  </div>
  <div class="page" id="page4">
    <div class="page-title">历史层级、可释性与同源性</div>

    <div class="form-group match-section" id="levelSection">
      <div class="match-title">请选择历史层级</div>
      <div class="match-options" id="levelOptions">
        <label><input type="radio" name="histLevel" value="早期"> 早期</label>
        &emsp;
        <label><input type="radio" name="histLevel" value="中期"> 中期</label>
        &emsp;
        <label><input type="radio" name="histLevel" value="后期"> 后期</label>
      </div>
    </div>

    <div class="radio-row">
      <div class="radio-label"></div>
      <div class="radio-options">
        <label><strong>是&emsp;</strong></label>
        <label><strong>&emsp;&emsp;否</strong></label>
      </div>
    </div>
    
    <div class="form-group match-section" id="etymologySection">
      <div class="radio-row">
        <div class="radio-label">与施借语言可释：
          <span class="help-tip" aria-label="help">
            <img src="img/question.png" alt="问号">
            <span class="tooltip">
              与施借语言可释，即一个被怀疑是借词的词语，其语音演变过程必须能够用施借语言的语音体系和发展规律来合理解释。
            </span>
          </span>
        </div>
        <div class="radio-options" id="explainableOptions">
          <label><input type="radio" name="explainable" value="yes">&emsp;&emsp;</label>
          <label><input type="radio" name="explainable" value="no"></label>
        </div>
      </div>
      
      <div class="radio-row">
        <div class="radio-label">与近源姐妹语言同源：
          <span class="help-tip" aria-label="help">
            <img src="img/question.png" alt="问号">
            <span class="tooltip">
              与谱系关系更近的姊妹语言或方言中的词同源
            </span>
          </span>
        </div>
        <div class="radio-options" id="cognateOptions">
          <label><input type="radio" name="cognate" value="yes">&emsp;&emsp;</label>
          <label><input type="radio" name="cognate" value="no"></label>
        </div>
      </div>
      
      <div class="radio-row hidden" id="originChooser" style="margin-top:16px;">
        <div class="radio-label">词汇类型：</div>
        <div class="radio-options">
          <label><input type="radio" name="originType" value="借词"> 借词</label>
          <label><input type="radio" name="originType" value="固有词"> 固有词</label>
        </div>
      </div>      
    
      <div class="sub-note hidden" id="autoOriginNote"></div>
    </div>    

    <div class="page-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button nextBtn">下一页</button>
      </div>
    </div>

    <div class="form-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button" onclick="saveVocab()">保存并返回</button>
        <button type="button" class="nav-button" onclick="showPage(1)">返回</button>
      </div>
    </div>
  </div>

  <div class="page" id="page5">
    <div class="page-title">时间信息</div>

    <div class="form-group" id="borrowSourceGroup">
      <div class="match-title">
        <label><strong>请选择这个借词借入的时代以及语言</strong></label><br>
      </div>
      <div class="match-options">
        <label><input type="radio" name="borrowSource" value="上古汉语"> 上古汉语</label><br><br>
        <label><input type="radio" name="borrowSource" value="中古汉语"> 中古汉语</label><br><br>
        <label><input type="radio" name="borrowSource" value="近代汉语"> 近代汉语</label><br><br>
        <label><input type="radio" name="borrowSource" value="现代汉语"> 现代汉语</label><br><br>
        <label>
          <input type="radio" name="borrowSource" value="其他">
          其他语言 <input type="text" id="borrowSourceOther" placeholder="请填写">
        </label>
      </div>
    </div>

    <div class="form-group" id="borrowChangeGroup">
      <div class="match-title">
        <label><strong>请选择这个借词的语音变化类型</strong></label><br>
      </div>
      <div class="match-options">
        <label><input type="radio" name="borrowChange" value="浊音清化"> 浊音清化</label><br><br>
        <label><input type="radio" name="borrowChange" value="轻唇音化"> 轻唇音化</label><br><br>
        <label><input type="radio" name="borrowChange" value="元音高化或低化"> 元音高化或低化</label><br><br>
        <label><input type="radio" name="borrowChange" value="复辅音简化"> 复辅音简化</label><br><br>
        <label>
          <input type="radio" name="borrowChange" value="其他">其他 <input type="text" id="borrowChangeOther" placeholder="请填写">
        </label>
      </div>
    </div>

    <div class="form-group time-range-section" id="timeRangeSection">
      <div class="time-range-title">请根据文献或者音变时间，填写或调整时间下限和上限</div>

      <div class="time-sentence">
        根据文献或历史记载，
        <span id="timeWordDisplay">暂无词汇</span>
        的
        <span class="time-inline">
          <select id="wordEventType" class="time-select">
            <option value="驯化">驯化</option>
            <option value="使用">使用</option>
            <option value="栽培">栽培</option>
            <option value="引进">引进</option>
          </select>
          时间是
          <input type="number" id="timeLower" class="time-input" placeholder="年份">
          <select id="timeLowerEra" class="time-select">
            <option value="BC">BC</option>
            <option value="AD">AD</option>
          </select>
          —
          <input type="number" id="timeUpper" class="time-input" placeholder="年份">
          <select id="timeUpperEra" class="time-select">
            <option value="BC">BC</option>
            <option value="AD">AD</option>
          </select>
        </span>
        ，<span id="timeConclusion"></span>
      </div>
      <div class="hint-text">*请点击查看一系列<a href="#" id="openTimeRefs">时间信息</a>作为参考，也可以做更加精确的调整。</div>
    </div>

    <div class="form-buttons">
      <div class="left-buttons">
        <button type="button" class="nav-button prevBtn">上一页</button>
      </div>
      <div class="right-buttons">
        <button type="button" class="nav-button" onclick="saveVocab()">保存并返回</button>
        <button type="button" class="nav-button" onclick="showPage(1)">返回</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="timeModalBackdrop" style="display:none;"></div>
  <div class="modal" id="timeModal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="timeModalTitle">
    <div class="modal-header">
      <h3 id="timeModalTitle">时间参考表</h3>
      <button type="button" class="modal-close" id="timeModalClose" aria-label="关闭">×</button>
    </div>

    <div class="modal-body">
      <div class="table-wrap">
        <h4 class="table-title">参考表 1</h4>
        <div class="ref-table-wrapper">
          <table class="ref-table" id="timeTable1">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="table-wrap">
        <h4 class="table-title">参考表 2</h4>
        <div class="ref-table-wrapper">
          <table class="ref-table" id="timeTable2">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div style="margin-bottom: 100px;"></div>
    </div>
  </div>
</body>

<script>
    let currentPage = 0;
    const totalPages = 6;

    let currentVocabPage = 1;
    const pageSize = 5;
    let totalVocabPages = 1;

    let isTreeFileRemoved = false;

    let vocabData = [];
    let editingVocabIndex = null;

    let originalDraft = null;

    function updateRemoveButtons() {
      const removeBtns = document.querySelectorAll(".remove-language");
      removeBtns.forEach(btn => btn.style.display = (languageContainer.children.length > 2 ? "inline-block" : "none"));
    }

    function addLanguageInput(value = "", lng = "", lat = "") {
      if (languageContainer.children.length >= 6) {
        alert("最多只能添加6种语言");
        return;
      }
      const div = document.createElement("div");
      div.className = "language-group";
      div.innerHTML = `
        <input type="text" class="language-input" placeholder="输入语言名称" value="${value}">
        <input type="text" class="coord-input lng-input" placeholder="经度" value="${lng}">
        <input type="text" class="coord-input lat-input" placeholder="纬度" value="${lat}">
        <button type="button" class="remove-language">移除</button>
      `;
      languageContainer.appendChild(div);
      updateRemoveButtons();

      div.querySelector(".remove-language").addEventListener("click", () => {
        div.remove();
        updateRemoveButtons();
        if (typeof window.languages === 'object') {
          window.languages = getLanguages();
          if (typeof renderTimeConclusion === 'function') renderTimeConclusion();
        }
      });
    }

    function getLanguages() {
      return Array.from(document.querySelectorAll(".language-input"))
        .map(i => i.value.trim())
        .filter(Boolean);
    }

    function getLanguageCoords() {
      const rows = Array.from(document.querySelectorAll("#language-container .language-group"));
      return rows.map(row => {
        const name = row.querySelector(".language-input")?.value.trim() || "";
        const lng  = row.querySelector(".lng-input")?.value.trim() || "";
        const lat  = row.querySelector(".lat-input")?.value.trim() || "";
        return { name, lng, lat };
      }).filter(x => x.name);
    }

    function renderTimeConclusion() {
      const type = document.querySelector('input[name="projectType"]:checked')?.value;
      const langs = (window.languages || []).filter(Boolean);
      const el = document.getElementById('timeConclusion');
      if (!el) return;

      const matchVal = document.querySelector('input[name="matchType"]:checked')?.value;
      const relaxedVal = document.querySelector('input[name="relaxedType"]:checked')?.value;

      const divisionWord = (matchVal === 'partial' && relaxedVal === 'branchOnly') ? '已全分化' : '未分化';

      if (!type || langs.length === 0) {
        el.textContent = `所以在该时间区间相关语言${divisionWord}。`;
        return;
      }

      const A = langs[0] || 'A';
      const rest = langs.slice(1).join('、') || 'B、C、D';

      if (type === '1') {
        el.textContent = `所以在该时间区间 ${A} 与 ${rest} ${divisionWord}。`;
      } else if (type === '2') {
        el.textContent = `所以在该时间区间 ${A} ${rest} ${divisionWord}。`;
      } else if (type === '3') {
        el.textContent = `所以在该时间区间 ${A} 的不同方言${divisionWord}。`;
      } else {
        el.textContent = `所以在该时间区间相关语言${divisionWord}。`;
      }
    }

    function eraYearToNumber(year, era) {
      if (year === '' || year == null) return null;
      const n = Number(year);
      if (!isFinite(n)) return null;
      return (era === 'BC') ? -Math.abs(n) : Math.abs(n);
    }

    function numberToEraYear(n) {
      if (n == null) return { year: '', era: 'BC' };
      return n < 0 ? { year: Math.abs(n), era: 'BC' } : { year: n, era: 'AD' };
    }

    function sortRange(a, b) {
      const x = (a == null) ? Infinity : a;
      const y = (b == null) ? Infinity : b;
      return x - y;
    }

    function normalizeTimeRange(raw) {
      const u = eraYearToNumber(raw.upper, raw.upperEra);
      const l = eraYearToNumber(raw.lower, raw.lowerEra);
      if (u == null && l == null) return null;

      let a = (u != null) ? u : l;
      let b = (l != null) ? l : u;

      let early = Math.min(a, b);
      let late  = Math.max(a, b);

      const up  = numberToEraYear(early);
      const low = numberToEraYear(late);
      return { upper: up.year, upperEra: up.era, lower: low.year, lowerEra: low.era, early, late };
    }

    function computeSuggestedProjectTime(vocabData) {
      if (!Array.isArray(vocabData) || vocabData.length === 0) return null;

      let minima = [], maxima = [];

      for (const v of vocabData) {
        const t = v?.timeInfo || v?.timeRange || null;
        if (!t) continue;

        const upper = eraYearToNumber(t.upper, t.upperEra);
        const lower = eraYearToNumber(t.lower, t.lowerEra);

        if (upper != null) minima.push(upper);
        if (lower != null) maxima.push(lower);
      }

      if (minima.length === 0 && maxima.length === 0) {
        return null;
      }

      const earliest = minima.length ? Math.min(...minima) : (maxima.length ? Math.min(...maxima) : null);
      const latest   = maxima.length ? Math.max(...maxima) : earliest;

      return normalizeTimeRange({
        upper: numberToEraYear(earliest).year,
        upperEra: numberToEraYear(earliest).era,
        lower: numberToEraYear(latest).year,
        lowerEra: numberToEraYear(latest).era
      });
    }

    function applyNormalizedProjectTime(suggest) {
      const upEl  = document.getElementById('projectTimeUpper');
      const upEEl = document.getElementById('projectTimeUpperEra');
      const loEl  = document.getElementById('projectTimeLower');
      const loEEl = document.getElementById('projectTimeLowerEra');

      if (!suggest) return;

      upEl.value  = suggest.upper;
      upEEl.value = suggest.upperEra;
      loEl.value  = suggest.lower;
      loEEl.value = suggest.lowerEra;

      if (upEEl) upEEl.textContent = suggest.upperEra;
      if (loEEl) loEEl.textContent = suggest.lowerEra;
    }

    function renderWordsForCategory(selectedCategory) {
      const host = document.getElementById('wordSelectHost');
      if (!host) return;

      if (selectedCategory === '其他') {
        if (host.firstElementChild && host.firstElementChild.tagName.toLowerCase() === 'input') {
          const input = host.firstElementChild;
          if (window.selectedWord) input.value = window.selectedWord;
          return;
        }
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'customWordInput';
        input.placeholder = '请输入词汇';
        input.className = 'custom-word-input';
        host.replaceChildren(input);
        if (window.selectedWord) input.value = window.selectedWord;

        input.addEventListener('input', () => {
          window.selectedWord = input.value.trim();
        });
        return;
      }

      let select = host.firstElementChild;
      if (!select || select.tagName.toLowerCase() !== 'select') {
        select = document.createElement('select');
        select.id = 'wordSelect';
        host.replaceChildren(select);
      }

      const list = (window.wordOptions && window.wordOptions[selectedCategory]) ? window.wordOptions[selectedCategory] : [];

      select.innerHTML = `<option value="">请选择词汇</option>`;
      list.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        select.appendChild(opt);
      });

      select.onchange = () => {
        window.selectedWord = select.value.trim();
      };
    }

    function setWordSelection(word) {
      const host = document.getElementById('wordSelectHost');
      if (!host || !host.firstElementChild) return;
      const el = host.firstElementChild;

      if (el.tagName.toLowerCase() === 'select') {
        const opt = Array.from(el.options).find(o => o.value === word);
        if (opt) el.value = word;
      } else if (el.tagName.toLowerCase() === 'input') {
        el.value = word || '';
      }
      window.selectedWord = word || '';
    }

    const maxRows = 6;

    function addDialectRow(valueDialect = "", valueForm = "") {
      const wordBody = document.getElementById("wordBody");
      if (!wordBody) return;

      const base = (window.languages || []).length;
      const currentCustom = wordBody.querySelectorAll("tr.custom-dialect-row").length;
      const remaining = Math.max(0, maxRows - base);

      if (currentCustom >= remaining) {
        alert("最多只能添加6种语言");
        return;
      }

      const tr = document.createElement("tr");
      tr.className = "custom-dialect-row";

      tr.innerHTML = `
        <td>
          <input type="text" class="custom-dialect" placeholder="输入语言名称" value="${valueDialect}">
        </td>
        <td>
          <div class="dialect-form-cell">
            <input type="text" class="syllable-input" placeholder="输入音节" value="${valueForm}">
            <button type="button" class="remove-language">移除</button>
          </div>
        </td>
      `;

      document.getElementById("wordBody").appendChild(tr);
      
      const total = wordBody.querySelectorAll("tr.custom-dialect-row").length;
      const hint = document.getElementById('wordHint');
      hint.textContent = `当前语言数：${base + total}；最多可再添加 ${maxRows - total - base} 行`;

      tr.querySelector(".remove-language").addEventListener("click", () => {
        tr.remove();
        const total = wordBody.querySelectorAll("tr.custom-dialect-row").length;
        hint.textContent = `当前语言数：${base + total}；最多可再添加 ${maxRows - total - base} 行`;
      });
    }

    function collectSyllablesFromPage2() {
      const displayEl = document.getElementById('currentWordDisplay');
      const tbody = document.getElementById('wordBody');

      if (!displayEl || !tbody) return null;

      const word = displayEl.textContent.trim();
      const rows = Array.from(tbody.querySelectorAll('tr'));

      const wordForms = rows.map(row => {
        const dialectCell = row.children[0];
        const formCell    = row.children[1];

        const dialect = dialectCell.querySelector('input')
          ? dialectCell.querySelector('input').value.trim()
          : dialectCell.textContent.trim();

        const wordFormInput = formCell.querySelector('input');
        const wordForm = wordFormInput ? wordFormInput.value.trim() : '';

        return { dialect, wordForm };
      })
      .filter(x => x.dialect || x.wordForm);

      if (!word && wordForms.length === 0) return null;

      return { wordForms };
    }

    function collectComparisonFromPage3() {
      const head = document.getElementById('compareHeadRow');
      const body = document.getElementById('compareBody');
      if (!head || !body) return null;

      const ths = Array.from(head.querySelectorAll('th'));
      const langs = ths.slice(2).map(th => th.textContent.trim());

      const rows = [];
      Array.from(body.querySelectorAll('tr')).forEach((tr, idx) => {
        const tds = Array.from(tr.children);
        const wordEl = tds[0].querySelector('input') || tds[0].querySelector('span');
        const word = (wordEl?.value ?? wordEl?.textContent ?? '').trim();

        let feature = [];
        const cbs = tds[1].querySelectorAll('input[type="checkbox"]');
        if (cbs.length) {
          feature = Array.from(cbs)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        } else {
          feature = [];
        }

        const forms = {};
        langs.forEach((lang, i) => {
          const cell = tds[i + 2];
          const el = cell.querySelector('input') || cell.querySelector('span');
          forms[lang] = (el?.value ?? el?.textContent ?? '').trim();
        });

        rows.push({ word, feature, forms, readonly: idx === 0 });
      });

      return { rows };
    }

    function getSelectedWord() {
      const host = document.getElementById('wordSelectHost');
      if (!host) return '';
      const el = host.firstElementChild;
      if (!el) return '';
      if (el.tagName.toLowerCase() === 'select') {
        return (el.value || '').trim();
      }
      if (el.tagName.toLowerCase() === 'input') {
        return (el.value || '').trim();
      }
      return '';
    }

    function populateSyllablePage(word, wordData) {
      const wordBody = document.getElementById("wordBody");
      const wordLabel = document.getElementById("currentWordDisplay");

      if (!wordBody || !wordLabel) return;

      wordLabel.textContent = word || "暂无词汇";

      if (wordData === "1") return;

      const savedMap = new Map();
      if (Array.isArray(wordData?.wordForms)) {
        wordData.wordForms.forEach(({ dialect, wordForm }) => {
          if (dialect) savedMap.set(dialect, wordForm || "");
        });
      }

      wordBody.innerHTML = "";

      const langs = (window.languages && Array.isArray(window.languages)) ? window.languages : [];

      langs.forEach(lang => {
        const tr = document.createElement("tr");

        const tdDialect = document.createElement("td");
        tdDialect.textContent = lang;
        tdDialect.classList.add("readonly-dialect");

        const tdForm = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.className = "syllable-input";
        input.placeholder = "输入音节";
        input.dataset.lang = lang;
        input.value = savedMap.get(lang) ?? "";
        tdForm.appendChild(input);

        tr.appendChild(tdDialect);
        tr.appendChild(tdForm);
        wordBody.appendChild(tr);
      });

      let remaining = Math.max(0, maxRows - langs.length);

      let customForms = [];
      if (Array.isArray(wordData?.wordForms)) {
        customForms = wordData.wordForms.filter(({ dialect }) => !langs.includes(dialect));
      }

      let trimmed = false;
      if (customForms.length > remaining) {
        customForms = customForms.slice(0, remaining);
        trimmed = true;
      }

      customForms.forEach(({ dialect, wordForm }) => {
        const tr = document.createElement("tr");
        tr.classList.add("custom-dialect-row");

        const tdDialect = document.createElement("td");
        const inpDia = document.createElement("input");
        inpDia.type = "text";
        inpDia.className = "custom-dialect";
        inpDia.placeholder = "输入语言名称";
        inpDia.value = dialect || "";
        tdDialect.appendChild(inpDia);

        const tdForm = document.createElement("td");
        const wrapper = document.createElement("div");
        wrapper.className = "dialect-form-cell";

        const inpForm = document.createElement("input");
        inpForm.type = "text";
        inpForm.className = "syllable-input";
        inpForm.placeholder = "输入音节";
        inpForm.value = wordForm || "";

        const btnRemove = document.createElement("button");
        btnRemove.type = "button";
        btnRemove.className = "remove-language";
        btnRemove.textContent = "移除";
        btnRemove.addEventListener("click", () => {
          tr.remove();
          const hint = document.getElementById('wordHint');
          const base = (window.languages || []).length;
          const total = wordBody.querySelectorAll("tr.custom-dialect-row").length;
          hint.textContent = `当前语言数：${base + total}；最多可再添加 ${maxRows - total - base} 行`;
        });

        wrapper.appendChild(inpForm);
        wrapper.appendChild(btnRemove);
        tdForm.appendChild(wrapper);

        tr.appendChild(tdDialect);
        tr.appendChild(tdForm);
        wordBody.appendChild(tr);
      });

      if (trimmed && typeof window.editingVocabIndex === "number" && window.editingVocabIndex >= 0 && window.vocabData?.[window.editingVocabIndex]) {
        const newWordForms = [
          ...langs.map(lang => ({ dialect: lang, wordForm: savedMap.get(lang) ?? "" })),
          ...customForms
        ];
        const prev = window.vocabData[window.editingVocabIndex];
        window.vocabData[window.editingVocabIndex] = {
          ...prev,
          wordData: { syllable: savedSyllable, wordForms: newWordForms }
        };
      }

      const hint = document.getElementById('wordHint');
      const base = (window.languages || []).length;
      const total = wordBody.querySelectorAll("tr.custom-dialect-row").length;
      hint.textContent = `当前语言数：${base + total}；最多可再添加 ${maxRows - total - base} 行`;

      window.dialectRows = document.querySelectorAll("#wordBody tr").length;

      setupMatchSection();
    };

    function setupMatchSection() {
      const fullNote = document.getElementById('fullNote');
      const relaxedOptions = document.getElementById('relaxedOptions');
      const relaxedNote = document.getElementById('relaxedNote');

      document.querySelectorAll('input[name="matchType"]').forEach(r => {
        r.addEventListener('change', () => {
          const val = document.querySelector('input[name="matchType"]:checked')?.value;

          if (val === 'full') {
            fullNote.classList.remove('hidden');
            relaxedOptions.classList.add('hidden');
            relaxedNote.classList.add('hidden');
            document.querySelectorAll('input[name="relaxedType"]').forEach(x => x.checked = false);
          } else if (val === 'partial') {
            fullNote.classList.add('hidden');
            relaxedOptions.classList.remove('hidden');
            relaxedNote.classList.add('hidden');
          }
        });
      });

      document.querySelectorAll('input[name="relaxedType"]').forEach(r => {
        r.addEventListener('change', () => {
          const val = document.querySelector('input[name="relaxedType"]:checked')?.value;
          if (val === 'branchOnly') {
            relaxedNote.classList.remove('hidden');
          } else {
            relaxedNote.classList.add('hidden');
          }
        });
      });
    };

    function populateTimeRange(entry) {
      const word = getSelectedWord();
      const wordSpan = document.getElementById('timeWordDisplay');
      if (wordSpan) {
        wordSpan.textContent = word || '暂无词汇';
        wordSpan.style.fontWeight = 'bold';
      }

      const eventType = entry?.timeInfo?.eventType || '使用';
      const lower = entry?.timeInfo?.lower ?? 5500;
      const lowerEra = entry?.timeInfo?.lowerEra || 'BC';
      const upper = entry?.timeInfo?.upper ?? 4000;
      const upperEra = entry?.timeInfo?.upperEra || 'BC';

      const selType = document.getElementById('wordEventType');
      const inpLower = document.getElementById('timeLower');
      const selLowerEra = document.getElementById('timeLowerEra');
      const inpUpper = document.getElementById('timeUpper');
      const selUpperEra = document.getElementById('timeUpperEra');

      if (selType) selType.value = eventType;
      if (inpLower) inpLower.value = lower;
      if (selLowerEra) selLowerEra.value = lowerEra;
      if (inpUpper) inpUpper.value = upper;
      if (selUpperEra) selUpperEra.value = upperEra;
    };

    const MAX_COMPARE_ROWS = 4;

    function buildCompareHead() {
      const head = document.getElementById('compareHeadRow');
      head.innerHTML = '';

      const thWord = document.createElement('th'); thWord.textContent = '词汇';
      const thFeat = document.createElement('th'); thFeat.textContent = '音韵对应';
      head.appendChild(thWord);
      head.appendChild(thFeat);

      const dialects = getDialectsFromPage2DOM();
      dialects.forEach(lang => {
        const th = document.createElement('th');
        th.textContent = lang;
        head.appendChild(th);
      });
    };

    function addCompareRow({ word = '', feature = '', forms = {}, readonly = false } = {}) {
      const tbody = document.getElementById('compareBody');
      const hint = document.getElementById('compareHint');
      const currentWords = tbody.querySelectorAll('tr').length;
      hint.textContent = `当前词汇数：${currentWords}；最多可再添加 ${MAX_COMPARE_ROWS - currentWords} 行`;
      
      if (!readonly && currentWords >= MAX_COMPARE_ROWS) {
        alert('最多只能添加4个词汇');
        return;
      }

      const dialects = getDialectsFromPage2DOM();

      const tr = document.createElement('tr');

      const tdWord = document.createElement('td');
      if (readonly) {
        const span = document.createElement('span');
        span.className = 'compare-readonly';
        span.textContent = word || '';
        tdWord.appendChild(span);
      } else {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'compare-input';
        input.placeholder = "参考词汇";
        input.value = word || '';
        tdWord.appendChild(input);
      }
      tr.appendChild(tdWord);

      const tdFeat = document.createElement('td');
      if (readonly) {
        const span = document.createElement('span');
        span.className = 'compare-readonly';
        span.textContent = '';
        tdFeat.appendChild(span);
      } else {
        const wrap = document.createElement('div');
        wrap.className = 'feature-options';

        const normalizeFeature = (f) => {
          if (Array.isArray(f)) return f;
          if (typeof f === 'string' && f.trim()) {
            return f.split(/[，,\s]+/).filter(Boolean);
          }
          return [];
        };
        const selected = new Set(normalizeFeature(feature));

        ['声母','韵母','声调'].forEach(text => {
          const label = document.createElement('label');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = text;
          if (selected.has(text)) cb.checked = true;
          label.appendChild(cb);
          label.appendChild(document.createTextNode(text));
          wrap.appendChild(label);
        });

        tdFeat.appendChild(wrap);
      }
      tr.appendChild(tdFeat);

      dialects.forEach(lang => {
        const td = document.createElement('td');
        const val = forms?.[lang] ?? '';
        if (readonly) {
          const span = document.createElement('span');
          span.className = 'compare-readonly';
          span.textContent = val;
          td.appendChild(span);
        } else {
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'compare-input';
          input.placeholder = "音节";
          input.value = val;
          td.appendChild(input);
        }
        tr.appendChild(td);
      });

      if (!readonly) {
        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.className = 'delete-button';
        btnRemove.textContent = '移除';
        btnRemove.style.marginTop = '6px';
        tr.children[0].appendChild(btnRemove);
        btnRemove.addEventListener('click', () => {
          tr.remove();
          const total = tbody.querySelectorAll('tr').length;
          hint.textContent = `当前词汇数：${total}；最多可再添加 ${MAX_COMPARE_ROWS - total} 行`;
        });
      }

      document.getElementById('compareBody').appendChild(tr);

      const total = tbody.querySelectorAll('tr').length;
      hint.textContent = `当前词汇数：${total}；最多可再添加 ${MAX_COMPARE_ROWS - total} 行`;
    }

    function populateBorrowPage(entry) {
      const box1 = document.getElementById('borrowSourceGroup');
      const box2 = document.getElementById('borrowChangeGroup');
      type = document.querySelector('input[name="originType"]:checked')?.value;
      if (!type) {
        const ex = document.querySelector('input[name="explainable"]:checked')?.value; // yes/no
        const cg = document.querySelector('input[name="cognate"]:checked')?.value;     // yes/no
        if (ex && cg && ex !== cg) {
          type = (ex === 'yes' && cg === 'no') ? '借词' : '固有词';
        }
      }

      if (!box1 || !box2) return;

      if (type !== '借词') {
        box1.classList.add('hidden');
        box2.classList.add('hidden');
        return;
      }
      box1.classList.remove('hidden');
      box2.classList.remove('hidden');

      document.querySelectorAll('input[name="borrowSource"]').forEach(x => x.checked = false);
      document.querySelectorAll('input[name="borrowChange"]').forEach(x => x.checked = false);

      const srcOther = document.getElementById('borrowSourceOther');
      if (entry.borrowSource) {
        const r = document.querySelector(`input[name="borrowSource"][value="${entry.borrowSource}"]`);
        if (r) {
          r.checked = true;
          r.dispatchEvent(new Event('change'));
        }
      }
      if (entry.borrowSource === '其他' && srcOther) {
        srcOther.value = entry.borrowSourceOther || '';
        srcOther.disabled = false;
      }

      const changeOther = document.getElementById('borrowChangeOther');
      if (entry.borrowChange) {
        const r = document.querySelector(`input[name="borrowChange"][value="${entry.borrowChange}"]`);
        if (r) {
          r.checked = true;
          r.dispatchEvent(new Event('change'));
        }
      }
      if (entry.borrowChange === '其他' && changeOther) {
        changeOther.value = entry.borrowChangeOther || '';
        changeOther.disabled = false;
      }
    };

    function collectBorrowFromLastPage() {
      const showSource = !document.getElementById('borrowSourceGroup')?.classList.contains('hidden');
      const showChange = !document.getElementById('borrowChangeGroup')?.classList.contains('hidden');

      if (!showSource && !showChange) {
        return {
          borrowSource: null,
          borrowSourceOther: null,
          borrowChange: null,
          borrowChangeOther: null
        };
      }

      const src = document.querySelector('input[name="borrowSource"]:checked')?.value || null;
      const srcOtherVal = document.getElementById('borrowSourceOther')?.value?.trim() || null;

      const chg = document.querySelector('input[name="borrowChange"]:checked')?.value || null;
      const chgOtherVal = document.getElementById('borrowChangeOther')?.value?.trim() || null;

      return {
        borrowSource: src,
        borrowSourceOther: (src === '其他' ? (srcOtherVal || null) : null),
        borrowChange: chg,
        borrowChangeOther: (chg === '其他' ? (chgOtherVal || null) : null)
      };
    }

    function collectTimeFromLastPage() {
      const eventType = document.getElementById('wordEventType')?.value || '使用';
      const lower = document.getElementById('timeLower')?.value;
      const lowerEra = document.getElementById('timeLowerEra')?.value || 'BC';
      const upper = document.getElementById('timeUpper')?.value;
      const upperEra = document.getElementById('timeUpperEra')?.value || 'BC';

      const toNum = v => (v === '' || v == null) ? null : Number(v);

      return {
        eventType,
        lower: toNum(lower),
        lowerEra,
        upper: toNum(upper),
        upperEra
      };
    }

    function getDialectsFromPage2DOM() {
      const tbody = document.getElementById('wordBody');
      if (!tbody) return [];

      const dialects = [];

      tbody.querySelectorAll('tr:not(.custom-dialect-row)').forEach(tr => {
        const t0 = tr.children?.[0];
        const name = t0 ? t0.textContent.trim() : '';
        if (name) dialects.push(name);
      });

      tbody.querySelectorAll('tr.custom-dialect-row').forEach(tr => {
        const inp = tr.querySelector('td:first-child input.custom-dialect');
        const name = inp ? inp.value.trim() : '';
        if (name) dialects.push(name);
      });

      return Array.from(new Set(dialects));
    }

    function populateComparisonPage(word, wordData, compData) {
      buildCompareHead();
      const dialects = getDialectsFromPage2DOM();

      const map = new Map();
      if (Array.isArray(wordData?.wordForms)) {
        wordData.wordForms.forEach(({ dialect, wordForm }) => {
          if (dialect) map.set(dialect, wordForm || '');
        });
      }

      const tbody = document.getElementById('compareBody');
      tbody.innerHTML = '';

      const formsObj = {};
      dialects.forEach(lang => { formsObj[lang] = map.get(lang) ?? ''; });

      addCompareRow({
        word: word || '',
        feature: '',
        forms: formsObj,
        readonly: true
      });

      if (Array.isArray(compData?.rows) && compData.rows.length > 1) {
        compData.rows.slice(1).forEach(row => {
          const adaptedForms = {};
          dialects.forEach(lang => {
            adaptedForms[lang] = row.forms?.[lang] ?? '';
          });
          addCompareRow({
            word: row.word || '',
            feature: row.feature || '',
            forms: adaptedForms,
            readonly: false
          });
        });
      }

      const hint = document.getElementById('compareHint');
      const total = tbody.querySelectorAll('tr').length;
      hint.textContent = `当前词汇数：${total}；最多可再添加 ${MAX_COMPARE_ROWS - total} 行`;
    };

    function generateCompareCSVFromEntry(entry) {
      const rows = Array.isArray(entry?.compData) ? entry.compData : [];
      if (!rows.length) return "词汇,音韵对应\n";

      const langOrder = [];
      rows.forEach(r => {
        const forms = r?.forms || {};
        Object.keys(forms).forEach(k => { if (!langOrder.includes(k)) langOrder.push(k); });
      });

      const header = ["词汇", "音韵对应", ...langOrder];

      const lines = [header.join(",")];
      rows.forEach(r => {
        const word = (r?.word ?? "").toString();
        const feature = Array.isArray(r?.feature) ? r.feature.join("、") : (r?.feature ?? "");
        const forms = r?.forms || {};
        const cols = [word, feature, ...langOrder.map(lang => (forms[lang] ?? ""))];

        const esc = (s) => {
          const str = (s == null) ? "" : String(s);
          return /[",\n]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
        };

        lines.push(cols.map(esc).join(","));
      });

      return lines.join("\n");
    }

    function textToCsvDataUrl(text) {
      return "data:text/csv;charset=utf-8," + encodeURIComponent(text || "");
    }

    function downloadCSV(filename, rows) {
      if (!Array.isArray(rows) || rows.length === 0) return;
      const csv = rows.map(r =>
        r.map(cell => {
          const s = (cell ?? '').toString();
          if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
          return s;
        }).join(',')
      ).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function buildVocabListCSV(data) {
      const header = [
        '词项','历史层次','完全普遍对应','不完全普遍对应','放宽的完全普遍对应',
        '时间信息','证据词汇','录入时间'
      ];
      const lines = [header];

      (data || []).forEach(item => {
        const full = item?.match?.type === 'full' || item?.fullMatch === true ? '是' : '否';
        const partial = item?.match?.type === 'partial' || item?.partialMatch === true ? '是' : '否';

        let relaxed = '否';
        if (item?.relaxedMatch === true || item?.match?.relaxedType) relaxed = '是';

        const t = item?.timeInfo;
        const timeText = t
          ? `${(t.lower ?? '')} ${(t.lowerEra ?? '')} — ${(t.upper ?? '')} ${(t.upperEra ?? '')}`.trim()
          : '--';

        const evidenceText = item?.evidence ? item.evidence : '--';

        lines.push([
          item?.word ?? '--',
          item?.level ?? '--',
          full,
          partial,
          relaxed,
          timeText || '--',
          evidenceText,
          item?.recordedAt ?? '--'
        ]);
      });

      return lines;
    }

    function buildAllVocabsEvidenceCSV(data, projectLangs = []) {
      const out = [];

      (data || []).forEach((v, idx) => {
        const word = v?.word ?? `词${idx+1}`;
        const langs = Array.isArray(projectLangs) ? projectLangs : [];

        const header = ['词汇','音韵对应', ...langs];
        out.push(header);

        const rows = v?.compData?.rows || [];
        rows.forEach((r, rIdx) => {
          const featText = Array.isArray(r?.feature) ? r.feature.join(';') : (r?.feature || '');
          const line = [
            rIdx === 0 ? (r?.word || word) : (r?.word || ''),
            featText
          ];

          langs.forEach(L => {
            line.push( (r?.forms?.[L] ?? '') );
          });

          out.push(line);
        });

        out.push(['']);
      });

      return out;
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!Auth.isLoggedIn()) {
        window.location.href = "index.html?login=true";
        return;
      }

      Auth.init('#userStatus');
      Auth.bindProfileName('#userStatus');

      const currentUser = Auth.getCurrentUser();

      const urlParams = new URLSearchParams(window.location.search);
      let projectId = urlParams.get("id");

      document.querySelector(".page-buttons").style.display = "none";

      if (!projectId) {
        const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
        const ids = drafts.map(d => d.id).filter(Boolean);
        let maxNum = 0;
        ids.forEach(id => {
          const match = id.match(/proj_(\\d+)/);
          if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNum) maxNum = num;
          }
        });
        projectId = `proj_${maxNum + 1}`;
        sessionStorage.setItem("editingProjectId", projectId);
      }

      document.getElementById("projectId").value = projectId;

      const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
      const existing = drafts.find(p => p.id === projectId);

      const treeFileInput = document.getElementById("treeFile");
      const viewTreeFile = document.getElementById("viewTreeFile");
      const removeTreeFile = document.getElementById("removeTreeFile");
      const treeFileActions = document.getElementById("treeFileActions");

      if (existing) {
        if (existing && currentUser && existing.authorId !== currentUser.id) {
            window.location.href = "projects.html";
            return;
        }

        document.getElementById("infoPageTitle").textContent = "编辑项目";
        document.getElementById("vocabPageTitle").textContent = "编辑项目";
        document.getElementById("projectName").value = existing.projectName || "未命名项目";
        document.getElementById("projectDesc").value = existing.projectDesc || "";
        document.getElementById("references").value = existing.references || "";
        originalDraft = JSON.stringify(existing);

        if (existing && existing.projectName) {
          document.title = existing.projectName;
        } else {
          document.title = "新建项目";
        }

        if (existing.projectType) {
          const radio = document.querySelector(`input[name=\"projectType\"][value=\"${existing.projectType}\"]`);
          if (radio) radio.checked = true;
        }

        if (existing?.treeFile && !isTreeFileRemoved) {
          const content = existing.treeFile.content || "";
          const base64Data = content.includes(",") ? content.split(",")[1] : content;
          const mime = existing.treeFile.type || "application/octet-stream";
          const blob = base64ToBlob(base64Data, mime);
          const url = URL.createObjectURL(blob);

          window.currentTreeDataURL = url;
          window.currentTreeFileName = existing.treeFile.name || "treefile";
          treeFileActions.style.display = "flex";
        }

        vocabData = existing.vocabList || [];
        loadVocabList(vocabData);
        const suggest = computeSuggestedProjectTime(vocabData);
        if (suggest) {
            applyNormalizedProjectTime(suggest);
        }
      }

      window.languages = getLanguages();
      languageContainer = document.getElementById("language-container");

      languageContainer.addEventListener("input", () => {
        window.languages = getLanguages();
        renderTimeConclusion();
      });

      document.querySelectorAll('input[name="projectType"]').forEach(r => {
        r.addEventListener('change', renderTimeConclusion);
      });

      window.languageContainer = languageContainer;

      if (existing?.languageCoords && Array.isArray(existing.languageCoords) && existing.languageCoords.length) {
        existing.languageCoords.forEach(({name, lng, lat}) => addLanguageInput(name || "", lng || "", lat || ""));
        const missingCount = 2 - existing.languageCoords.length;
        for (let i = 0; i < missingCount; i++) addLanguageInput();
      } else if (existing?.languages && Array.isArray(existing.languages)) {
        existing.languages.forEach(name => addLanguageInput(name));
        const missingCount = 2 - existing.languages.length;
        for (let i = 0; i < missingCount; i++) addLanguageInput();
      } else {
        addLanguageInput();
        addLanguageInput();
      }

      document.getElementById("addLanguageBtn").addEventListener("click", () => addLanguageInput());
      window.languages = getLanguages();
      renderTimeConclusion();

      document.getElementById("viewTreeFile").addEventListener("click", () => {
        const dataURL =
          window.tempTreeFile?.dataURL ||
          window.currentTreeDataURL ||
          existing?.treeFile?.content || null;

        if (!dataURL) return;

        if (dataURL.startsWith('data:')) {
          const arr = dataURL.split(',');
          const mimeMatch = arr[0].match(/data:(.*);base64/);
          const mime = (mimeMatch && mimeMatch[1]) || 'application/octet-stream';
          const blob = base64ToBlob(arr[1], mime);
          const url = URL.createObjectURL(blob);
          window.open(url, "_blank");
        } else {
          window.open(dataURL, "_blank");
        }
      });

      function base64ToBlob(base64, type) {
        const binary = atob(base64);
        const array = [];
        for (let i = 0; i < binary.length; i++) {
          array.push(binary.charCodeAt(i));
        }
        return new Blob([new Uint8Array(array)], { type: type });
      }

      treeFileInput.addEventListener("change", () => {
        const file = treeFileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.tempTreeFile = {
            name: file.name,
            type: file.type,
            dataURL: e.target.result
          };

          window.currentTreeDataURL = null;
          window.currentTreeFileName = file.name;
          treeFileActions.style.display = "flex";
        };
        
        reader.readAsDataURL(file);
      });

      removeTreeFile.addEventListener("click", () => {
        treeFileInput.value = "";
        window.tempTreeFile = null;
        window.currentTreeDataURL = null;
        window.currentTreeFileName = null;
        treeFileActions.style.display = "none";
        isTreeFileRemoved = true;
      });

      window.deleteVocab = function(id) {
        if (confirm("确定要删除该词汇吗？")) {
          const index = vocabData.findIndex(item => item.id === id);
          if (index !== -1) {
            vocabData.splice(index, 1);
            loadVocabList(vocabData);
          }

          const totalAfterDelete = Math.ceil(vocabData.length / pageSize);
          if (currentVocabPage > totalAfterDelete) {
            currentVocabPage = Math.max(1, totalAfterDelete);
          }

            loadVocabList();
            alert("已删除词汇");
        }
      };

      document.getElementById("addVocabBtn").addEventListener("click", () => {
        editingVocabIndex = null;
        resetVocabWizardState();
        currentPage = 2;
        showPage(currentPage);

        document.querySelectorAll('input[name="category"]').forEach(r => r.checked = false);
        const sel = document.getElementById("wordSelect");
        if (sel) sel.innerHTML = `<option value="">请选择词汇</option>`;

        populateSyllablePage(null, null);
      });

      window.wordOptions = {};

      fetch("sheets/word_options.csv")
        .then(res => res.text())
        .then(text => {
          const map = {};
          text.split(/\r?\n/).filter(l => l.trim()).forEach(line => {
            const [cat, word] = line.split(",");
            if (!cat || !word) return;
            (map[cat] ||= []).push(word);
          });
          window.wordOptions = map;

          const currentCat = document.querySelector('input[name="category"]:checked')?.value;
          if (currentCat) {
            renderWordsForCategory(currentCat);
          }
        })
        .catch(err => {
          console.error("无法加载词表 CSV:", err);
          if (!window.wordOptions || Object.keys(window.wordOptions).length === 0) {
            window.wordOptions = {
              "工具质料": ["石","铜","铁","木","骨","牙","金","锡","银"],
              "禾谷类作物": ["稻","小麦","玉米"],
              "蔬菜": ["白菜","萝卜"],
              "水果": ["苹果","梨"],
              "家畜": ["牛","羊"],
              "外来文化概念": ["佛","汉字","钱币"]
            };
            const currentCat = document.querySelector('input[name="category"]:checked')?.value;
            if (currentCat) renderWordsForCategory(currentCat);
          }
        });

      document.querySelectorAll('input[name="category"]').forEach(radio => {
        radio.addEventListener('change', () => {
          renderWordsForCategory(radio.value);
        });
      });

      document.getElementById("addColumnBtn")?.addEventListener("click", () => {
        addDialectRow();
      });

      (function setupLevelAndEtymology() {
        const originChooser = document.getElementById('originChooser');
        const autoOriginNote = document.getElementById('autoOriginNote');

        function updateOriginUI() {
          const ex = document.querySelector('input[name="explainable"]:checked')?.value;
          const cg = document.querySelector('input[name="cognate"]:checked')?.value;

          if (!ex || !cg) {
            originChooser.classList.add('hidden');
            autoOriginNote.classList.add('hidden');
            autoOriginNote.textContent = '';
            document.querySelectorAll('input[name="originType"]').forEach(x => x.checked = false);
            return;
          }

          if (ex === cg) {
            originChooser.classList.remove('hidden');
            autoOriginNote.classList.add('hidden');
            autoOriginNote.textContent = '';
          } else {
            originChooser.classList.add('hidden');
            document.querySelectorAll('input[name="originType"]').forEach(x => x.checked = false);

            const isBorrowed = (ex === 'yes' && cg === 'no');
            autoOriginNote.textContent = isBorrowed ? '*这个词是借词' : '*这个词是固有词';
            autoOriginNote.classList.remove('hidden');
          }
        }

        document.querySelectorAll('input[name="explainable"]').forEach(r => r.addEventListener('change', updateOriginUI));
        document.querySelectorAll('input[name="cognate"]').forEach(r => r.addEventListener('change', updateOriginUI));
      })();

      (function setupBorrowPage() {
        const srcOther = document.getElementById('borrowSourceOther');
        const changeOther = document.getElementById('borrowChangeOther');

        if (srcOther) srcOther.disabled = true;
        if (changeOther) changeOther.disabled = true;

        document.querySelectorAll('input[name="borrowSource"]').forEach(r => {
          r.addEventListener('change', () => {
            if (r.checked && r.value === '其他') {
              srcOther.disabled = false;
            } else if (r.checked) {
              srcOther.value = '';
              srcOther.disabled = true;
            }
          });
        });

        document.querySelectorAll('input[name="borrowChange"]').forEach(r => {
          r.addEventListener('change', () => {
            if (r.checked && r.value === '其他') {
              changeOther.disabled = false;
            } else if (r.checked) {
              changeOther.value = '';
              changeOther.disabled = true;
            }
          });
        });
      })();

      const timeModal = document.getElementById('timeModal');
      const timeModalBackdrop = document.getElementById('timeModalBackdrop');
      const openTimeRefs = document.getElementById('openTimeRefs');
      const btnCloseTime = document.getElementById('timeModalClose');

      function openTimeModal(){
        if (!timeModal || !timeModalBackdrop) return;
        timeModal.style.display = 'block';
        timeModalBackdrop.style.display = 'block';
        document.body.classList.add('modal-open');
      }
      function closeTimeModal(){
        if (!timeModal || !timeModalBackdrop) return;
        timeModal.style.display = 'none';
        timeModalBackdrop.style.display = 'none';
        document.body.classList.remove('modal-open');
      }

      btnCloseTime?.addEventListener('click', closeTimeModal);
      timeModalBackdrop?.addEventListener('click', closeTimeModal);

      function parseCSV(text){
        const rows = text.split(/\r?\n/).filter(l => l.trim().length > 0);
        return rows.map(line => line.split(','));
      }

      function renderTable(tableId, data, options = {}) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) return;

        const head = data[0] || [];
        const headTr = document.createElement('tr');
        head.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h ?? '';
          headTr.appendChild(th);
        });
        thead.appendChild(headTr);

        const rows = data.slice(1);
        const groupFirst = !!options.groupFirstCol;

        let groupInfo = null;
        if (groupFirst && rows.length > 0) {
          groupInfo = [];
          let i = 0;
          while (i < rows.length) {
            const start = i;
            const txt = (rows[i] && rows[i][0]) ?? '';
            let span = 1;
            i++;
            while (i < rows.length && ((rows[i] && rows[i][0]) ?? '') === txt) {
              span++;
              i++;
            }
            groupInfo.push({ startIdx: start, span, text: txt });
          }
        }

        let groupMap = null;
        if (groupFirst && groupInfo) {
          groupMap = new Array(rows.length).fill(null);
          groupInfo.forEach(block => {
            groupMap[block.startIdx] = { draw: true, rowspan: block.span, text: block.text };
            for (let k = block.startIdx + 1; k < block.startIdx + block.span; k++) {
              groupMap[k] = { draw: false };
            }
          });
        }

        rows.forEach((arr, rIdx) => {
          const tr = document.createElement('tr');
          if (groupFirst) {
            const g = groupMap ? groupMap[rIdx] : null;
            if (g && g.draw) {
              const td = document.createElement('td');
              td.textContent = g.text ?? '';
              if (g.rowspan > 1) td.rowSpan = g.rowspan;
              tr.appendChild(td);
            }
            for (let c = 1; c < head.length; c++) {
              const td = document.createElement('td');
              td.textContent = (arr && arr[c]) ?? '';
              tr.appendChild(td);
            }
          } else {
            for (let c = 0; c < head.length; c++) {
              const td = document.createElement('td');
              td.textContent = (arr && arr[c]) ?? '';
              tr.appendChild(td);
            }
          }

          tbody.appendChild(tr);
        });
      }

      function loadXlsxOrCsv(url){
        if (url.toLowerCase().endsWith('.csv')) {
          return fetch(url).then(r => r.text()).then(txt => {
            const rows = txt.split(/\r?\n/).filter(l => l.trim().length > 0);
            return rows.map(line => line.split(','));
          });
        }

        return fetch(url).then(r => r.arrayBuffer()).then(buf => {
          if (!window.XLSX) throw new Error('未引入 SheetJS（xlsx.full.min.js），无法解析 .xlsx');
          const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });
          const first = wb.SheetNames[0];
          const ws = wb.Sheets[first];
          return XLSX.utils.sheet_to_json(ws, { header: 1 });
        });
      }

      let timeRefsLoaded = false;
      function loadTimeRefsOnce(){
        if (timeRefsLoaded) return;
        Promise.all([
          loadXlsxOrCsv('sheets/ref1.xlsx').then(data => renderTable('timeTable1', data, { groupFirstCol: true })),
          loadXlsxOrCsv('sheets/ref2.xlsx').then(data => renderTable('timeTable2', data, { groupFirstCol: true })),
        ]).then(() => {
          timeRefsLoaded = true;
        }).catch(err => {
          console.error('加载参考表失败：', err);
        });
      }

      openTimeRefs?.addEventListener('click', (e) => {
        e.preventDefault();
        openTimeModal();
        loadTimeRefsOnce();
      });

      function resetVocabWizardState() {
        document.querySelectorAll('input[name="category"]').forEach(r => r.checked = false);
        const sel = document.getElementById('wordSelect');
        if (sel) sel.innerHTML = `<option value="">请选择词汇</option>`;

        document.getElementById('currentWordDisplay').textContent = '暂无词汇';
        document.getElementById('wordBody')?.replaceChildren();
        document.querySelectorAll('input[name="matchType"]').forEach(r => r.checked = false);
        document.getElementById('fullNote')?.classList.add('hidden');
        document.getElementById('relaxedOptions')?.classList.add('hidden');
        document.getElementById('relaxedNote')?.classList.add('hidden');
        document.querySelectorAll('input[name="relaxedType"]').forEach(r => r.checked = false);

        document.getElementById('compareHeadRow')?.replaceChildren();
        document.getElementById('compareBody')?.replaceChildren();
        const ch = document.getElementById('compareHint'); if (ch) ch.textContent = '';

        document.querySelectorAll('input[name="histLevel"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="explainable"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="cognate"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="originType"]').forEach(r => r.checked = false);
        document.getElementById('originChooser')?.classList.add('hidden');
        const note = document.getElementById('autoOriginNote');
        if (note) { note.classList.add('hidden'); note.textContent = ''; }

        document.querySelectorAll('input[name="borrowSource"]').forEach(r => r.checked = false);
        const bso = document.getElementById('borrowSourceOther');
        if (bso) {
          bso.value='';
          bso.disabled = true;
        }
        document.querySelectorAll('input[name="borrowChange"]').forEach(r => r.checked = false);
        const bco = document.getElementById('borrowChangeOther');
        if (bco) {
          bco.value='';
          bco.disabled = true;
        }

        document.getElementById('timeWordDisplay').textContent = '暂无词汇';
        document.getElementById('wordEventType') && (document.getElementById('wordEventType').value = '使用');
        document.getElementById('timeLower') && (document.getElementById('timeLower').value = '5500');
        document.getElementById('timeLowerEra') && (document.getElementById('timeLowerEra').value = 'BC');
        document.getElementById('timeUpper') && (document.getElementById('timeUpper').value = '4000');
        document.getElementById('timeUpperEra') && (document.getElementById('timeUpperEra').value = 'BC');
      }

      document.getElementById('exportVocabTableBtn')?.addEventListener('click', () => {
        const rows = buildVocabListCSV(vocabData);
        downloadCSV('分化信息.csv', rows);
      });

      document.getElementById('exportAllVocabsBtn')?.addEventListener('click', () => {
        const rows = buildAllVocabsEvidenceCSV(vocabData, (window.languages || []));
        downloadCSV('全部词汇_证据.csv', rows);
      });

      document.getElementById('addCompareRowBtn')?.addEventListener('click', () => {
        addCompareRow();
      });

      document.getElementById("prevVocabPage").addEventListener("click", () => {
        currentVocabPage--;
        loadVocabList();
      });

      document.getElementById("nextVocabPage").addEventListener("click", () => {
        currentVocabPage++;
        loadVocabList();
      });

      function setupProfileMenu() {
        const profileImg = document.getElementById("profileImg");
        const dropdown = document.getElementById("dropdownMenu");

        if (!profileImg || !dropdown) return;

        profileImg.onclick = () => {
            if (sessionStorage.getItem("isLoggedIn") === "true") {
              dropdown.style.display = (dropdown.style.display === "none") ? "block" : "none";
            } else {
              window.location.href = "language_map.html";
            }
        };

        document.addEventListener("click", (e) => {
            if (!profileImg.contains(e.target) && !dropdown.contains(e.target)) {
              dropdown.style.display = "none";
            }
        });
      }

      setupProfileMenu();

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
          sessionStorage.removeItem("isLoggedIn");
          alert("已退出登录");
          location.reload();
        });
      }

      // window.addEventListener("beforeunload", (e) => {
      //   if (isDraftModified()) {
      //     e.preventDefault();
      //     e.returnValue = "您有未保存的更改，确定要离开吗？";
      //   }
      // });
    });

    function showPage(pageNum) {
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));

      let pageId = '';
      if (pageNum === 0) pageId = 'info';
      else if (pageNum === 1) pageId = 'vocab';
      else pageId = 'page' + (pageNum - 1);

      const pageEl = document.getElementById(pageId);
      if (pageEl) pageEl.classList.add('active');

      if (pageNum === 0) {
        currentPage = 0
        document.querySelector(".form-buttons").style.display = "flex";
        document.querySelector(".page-buttons").style.display = "none";
        return;
      } else if (pageNum === 1) {
        currentPage = 1;
        document.querySelector(".form-buttons").style.display = "none";
        document.querySelector(".page-buttons").style.display = "flex";

        if (pageEl && pageEl.querySelector('#projectTimeSection')) {
          const suggest = computeSuggestedProjectTime(vocabData);
          if (suggest) {
              applyNormalizedProjectTime(suggest);
          }
        }
        return;
      } else {
        if (currentPage === 3) {
          const category = document.querySelector('input[name="category"]:checked')?.value;
          const word = getSelectedWord();
          if (!category || !word) {
            alert("请选择类别和词汇");
            currentPage = 2;
            showPage(2);
            return;
          }
        }
        if (pageNum === 3) populateSyllablePage(getSelectedWord(), "1");
        if (pageNum === 4) {
            const wordData = collectSyllablesFromPage2();
            const prevCompData = (editingVocabIndex != null && vocabData[editingVocabIndex])
              ? vocabData[editingVocabIndex].compData
              : null;

            populateComparisonPage(getSelectedWord(), wordData || null, prevCompData || null);
        }
        if (pageNum === 6) {
          const cur_entry = (typeof editingVocabIndex === 'number') ? vocabData[editingVocabIndex] : null;
          populateBorrowPage(cur_entry || {});
          populateTimeRange(cur_entry || {});
          renderTimeConclusion();
        }
        document.getElementById(pageId).classList.add('active');
      }
    }

    document.querySelectorAll('.prevBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage--;
          showPage(currentPage);
        }
      });
    });

    document.querySelectorAll('.nextBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          showPage(currentPage);
        }
      });
    });

    window.saveDraft = function saveDraft() {
      const currentId = sessionStorage.getItem("editingProjectId");
      if (!currentId) return;

      const languageInputs = document.querySelectorAll(".language-input");
      const languages = getLanguages();
      const languageCoords = getLanguageCoords();

      const drafts = JSON.parse(localStorage.getItem("projectDrafts") || "[]");
      const existing = drafts.find(p => p.id === currentId);

      const projectName = document.getElementById("projectName").value.trim();
      const projectDesc = document.getElementById("projectDesc").value.trim();
      const references = document.getElementById("references").value.trim();
      const projectType = document.querySelector('input[name="projectType"]:checked')?.value || null;

      const vocabListForTime = Array.isArray(window.vocabData) ? window.vocabData : [];
      let computed = computeSuggestedProjectTime(vocabListForTime);

      if (!computed) {
        computed = normalizeTimeRange({
          upper: document.getElementById('projectTimeUpper')?.value || '',
          upperEra: document.getElementById('projectTimeUpperEra')?.value || 'BC',
          lower: document.getElementById('projectTimeLower')?.value || '',
          lowerEra: document.getElementById('projectTimeLowerEra')?.value || 'AD'
        });
      }

      const projectTimeRange = computed ? {
        upper: computed.upper,
        upperEra: computed.upperEra,
        lower: computed.lower,
        lowerEra: computed.lowerEra
      } : { upper: '', upperEra: 'BC', lower: '', lowerEra: 'AD' };

      let treeFileForSave = null;

      if (!isTreeFileRemoved) {
        if (window.tempTreeFile?.dataURL) {
          treeFileForSave = {
            name: window.tempTreeFile.name,
            type: window.tempTreeFile.type,
            content: window.tempTreeFile.dataURL
          };
        } else if (existing?.treeFile) {
          treeFileForSave = existing.treeFile;
        }
      }

      const isPublic = existing?.isPublic;

      function finalizeSave() {
        const draft = {
          id: currentId,
          projectName,
          projectDesc,
          references,
          projectType,
          languages,
          languageCoords,
          createdAt: existing?.createdAt || new Date().toLocaleString(),
          treeFile: treeFileForSave,
          vocabList: vocabData,
          projectTimeRange,
          authorId: existing?.authorId
                    || (typeof Auth !== "undefined" && Auth.getCurrentUser && Auth.getCurrentUser()?.id)
                    || (JSON.parse(sessionStorage.getItem("currentUser") || "null")?.id)
                    || sessionStorage.getItem("pendingAuthorId")
                    || "anonymous",
          author:  existing?.author
                    || (typeof Auth !== "undefined" && Auth.getCurrentUser && Auth.getCurrentUser()?.username)
                    || (JSON.parse(sessionStorage.getItem("currentUser") || "null")?.username)
                    || sessionStorage.getItem("pendingAuthorName")
                    || "未知用户",
          isPublic,
        };

        const index = drafts.findIndex(p => p.id === currentId);
        if (index !== -1) {
          drafts[index] = draft;
        } else {
          drafts.push(draft);
        }

        localStorage.setItem("projectDrafts", JSON.stringify(drafts));
        if (currentPage <= 1) alert("草稿已保存！");

        sessionStorage.removeItem("pendingAuthorId");
        sessionStorage.removeItem("pendingAuthorName");
      }

      finalizeSave();
      window.tempTreeFile = null;
      window.currentTreeDataURL = null;
    };

    window.loadVocabList = function loadVocabList(vocabList) {
      const tbody = document.getElementById("vocabBody");
      const noVocabs = document.getElementById("noVocabs");

      const totalVocabPages = Math.ceil(vocabData.length / pageSize);
      const start = (currentVocabPage - 1) * pageSize;

      tbody.innerHTML = "";

      if (vocabData.length === 0) {
        noVocabs.style.display = "block";
        return;
      }

      noVocabs.style.display = "none";

      vocabData.slice(start, start + pageSize).forEach((item, index) => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${item.word || "--"}</td>
          <td>${item.level || "--"}</td>
          <td>${item.fullMatch ? "Y" : "N"}</td>
          <td>${item.partialMatch ? "Y" : "N"}</td>
          <td>${item.relaxedMatch ? "Y" : "N"}</td>
          <td>${item.timeInfo ? (item.timeInfo.lower + " " + item.timeInfo.lowerEra + " - " + item.timeInfo.upper + " " + item.timeInfo.upperEra) : "--"}</td>
          <td>
            ${
              item.evidence
                ? `<a href="${item.evidence}" download="${item.word || 'compare'}_证据.csv">链接</a>`
                : "--"
            }
          </td>
          <td>${item.recordedAt || "--"}</td>
          <td>
            <button type="button" class="edit-button" data-id="${item.id}">编辑</button>
            <button type="button" class="delete-button" onclick="deleteVocab(${item.id})">删除</button>
          </td>
        `;

        tbody.appendChild(row);

        document.getElementById("vocabListTitle").textContent = `词汇列表（已有 ${vocabData.length} 个词汇）`;

        const editBtn = row.querySelector(".edit-button");

        editBtn.addEventListener("click", () => {
          const vocabId = parseInt(editBtn.getAttribute("data-id"));
          const vocab = vocabData.find(item => item.id === vocabId);
          editingVocabIndex = vocabData.findIndex(item => item.id === vocabId);
          const entry = vocab;

          currentPage = 2;
          showPage(currentPage);

          if (vocab) {
            const catRadio = document.querySelector(`input[name="category"][value="${vocab.category}"]`);
            if (catRadio) {
              catRadio.checked = true;
              catRadio.dispatchEvent(new Event('change'));
              const sel = document.getElementById("wordSelect");
              if (sel) sel.value = vocab.word || "";
            }
            renderWordsForCategory(vocab.category);
            setWordSelection(vocab.word);

            populateSyllablePage(entry.word, entry.wordData || null);
            
            (function restoreMatch(entry) {
              document.querySelectorAll('input[name="matchType"]').forEach(x => x.checked = false);
              document.querySelectorAll('input[name="relaxedType"]').forEach(x => x.checked = false);
              document.getElementById('fullNote').classList.add('hidden');
              document.getElementById('relaxedOptions').classList.add('hidden');
              document.getElementById('relaxedNote').classList.add('hidden');

              const full = !!entry.fullMatch;
              const partial = !!entry.partialMatch;
              const relaxed = !!entry.relaxedMatch;

              if (full && !partial) {
                const r = document.querySelector('input[name="matchType"][value="full"]');
                if (r) {
                  r.checked = true;
                  r.dispatchEvent(new Event('change'));
                }
              } else {
                const r = document.querySelector('input[name="matchType"][value="partial"]');
                if (r) {
                  r.checked = true;
                  r.dispatchEvent(new Event('change'));
                }
                const which = relaxed ? 'crossBranch' : 'branchOnly';
                const r2 = document.querySelector(`input[name="relaxedType"][value="${which}"]`);
                if (r2) {
                  r2.checked = true;
                  r2.dispatchEvent(new Event('change'));
                }
              }
            })(entry);

            (function restoreLevelAndEtymology(entry) {
              document.querySelectorAll('input[name="histLevel"]').forEach(x => x.checked = false);
              document.querySelectorAll('input[name="explainable"]').forEach(x => x.checked = false);
              document.querySelectorAll('input[name="cognate"]').forEach(x => x.checked = false);
              document.querySelectorAll('input[name="originType"]').forEach(x => x.checked = false);
              document.getElementById('originChooser').classList.add('hidden');
              const autoNote = document.getElementById('autoOriginNote');
              autoNote.classList.add('hidden');
              autoNote.textContent = '';

              if (entry.level) {
                const r = document.querySelector(`input[name="histLevel"][value="${entry.level}"]`);
                if (r) r.checked = true;
              }

              if (typeof entry.explainable === 'boolean') {
                const r = document.querySelector(`input[name="explainable"][value="${entry.explainable ? 'yes' : 'no'}"]`);
                if (r) r.checked = true;
              }
              if (typeof entry.cognate === 'boolean') {
                const r = document.querySelector(`input[name="cognate"][value="${entry.cognate ? 'yes' : 'no'}"]`);
                if (r) r.checked = true;
              }

              document.querySelectorAll('input[name="explainable"], input[name="cognate"]').forEach(x => {
                x.dispatchEvent(new Event('change'));
              });

              if (entry.explainable === entry.cognate && entry.originType) {
                const r = document.querySelector(`input[name="originType"][value="${entry.originType}"]`);
                if (r) r.checked = true;
              } else if (entry.explainable !== undefined && entry.cognate !== undefined && entry.explainable !== entry.cognate) {
                const isBorrowed = (entry.explainable === true && entry.cognate === false);
                autoNote.textContent = isBorrowed ? '*这个词是借词' : '*这个词是固有词';
                autoNote.classList.remove('hidden');
              }
            })(entry);

            populateComparisonPage(entry.word, entry.wordData || null, entry.compData || null);

            const cur_entry = (typeof editingVocabIndex === 'number') ? vocabData[editingVocabIndex] : null;
            populateBorrowPage(cur_entry || {});
            populateTimeRange(cur_entry || {});
          }
        });
      });

      document.getElementById("pageIndicator").textContent = `第 ${currentVocabPage} 页`;
      document.getElementById("prevVocabPage").style.display = (currentVocabPage > 1) ? "inline-block" : "none";
      document.getElementById("nextVocabPage").style.display = (currentVocabPage < totalVocabPages) ? "inline-block" : "none";
      document.querySelector(".pagination-container").style.display = (totalVocabPages > 1) ? "flex" : "none";
    }

    window.saveVocab = function saveVocab() {
      const loggedUser = JSON.parse(sessionStorage.getItem("loggedUser") || "{}");
      const category = document.querySelector('input[name="category"]:checked')?.value;
      const word = getSelectedWord();

      if (!category || !word) {
        alert("请选择类别和词汇");
        return;
      }

      const prev = (editingVocabIndex != null && vocabData[editingVocabIndex])
        ? vocabData[editingVocabIndex]
        : null;

      const collectedWordData = collectSyllablesFromPage2();
      const collectedCompData = collectComparisonFromPage3();
      const compArray = collectedCompData?.rows || prev?.compData || [];
      const matchVal = document.querySelector('input[name="matchType"]:checked')?.value;
      const relaxedVal = document.querySelector('input[name="relaxedType"]:checked')?.value;
      let fullMatch = true;
      let partialMatch = false;
      let relaxedMatch = false;
      const levelSel = document.querySelector('input[name="histLevel"]:checked')?.value || null;
      const exSel = document.querySelector('input[name="explainable"]:checked')?.value || null;
      const cgSel = document.querySelector('input[name="cognate"]:checked')?.value || null;
      const userOrigin = document.querySelector('input[name="originType"]:checked')?.value || null;
      const explainable = exSel === 'yes' ? true : (exSel === 'no' ? false : null);
      const cognate = cgSel === 'yes' ? true : (cgSel === 'no' ? false : null);
      const borrowPack = collectBorrowFromLastPage();
      const timePack = collectTimeFromLastPage();
      const csvText = generateCompareCSVFromEntry({ compData: compArray });
      const evidenceCsvDataUrl = textToCsvDataUrl(csvText);

      if (matchVal === 'full') {
        fullMatch = true;
        partialMatch = false;
        relaxedMatch = false;
      } else if (matchVal === 'partial') {
        fullMatch = false;
        partialMatch = true;
        relaxedMatch = (relaxedVal === 'crossBranch');
      }

      let inferredOrigin = null;
      if (explainable !== null && cognate !== null) {
        if (explainable === cognate) {
          inferredOrigin = userOrigin || null;
        } else {
          inferredOrigin = (explainable === true && cognate === false) ? '借词' : '固有词';
        }
      }
      const isBorrow = (inferredOrigin ?? prev?.originType) === '借词';

      const vocabEntry = {
        id: editingVocabIndex === null
          ? (vocabData.length > 0 ? Math.max(...vocabData.map(v => v.id)) + 1 : 1)
          : vocabData[editingVocabIndex].id,
        category,
        word,
        wordData: collectedWordData ?? prev?.wordData ?? null,
        compData: collectedCompData ?? prev?.compData ?? null,
        level: (levelSel ?? prev?.level ?? ""),
        fullMatch: (typeof fullMatch === 'boolean') ? fullMatch : (prev?.fullMatch ?? false),
        partialMatch: (typeof partialMatch === 'boolean') ? partialMatch : (prev?.partialMatch ?? false),
        relaxedMatch: (typeof relaxedMatch === 'boolean') ? relaxedMatch : (prev?.relaxedMatch ?? false),
        explainable: (explainable ?? prev?.explainable ?? null),
        cognate: (cognate ?? prev?.cognate ?? null),
        originType: (inferredOrigin ?? prev?.originType ?? null),
        borrowSource: isBorrow ? (borrowPack.borrowSource ?? prev?.borrowSource ?? null) : null,
        borrowSourceOther: isBorrow ? (borrowPack.borrowSourceOther ?? prev?.borrowSourceOther ?? null) : null,
        borrowChange: isBorrow ? (borrowPack.borrowChange ?? prev?.borrowChange ?? null) : null,
        borrowChangeOther: isBorrow ? (borrowPack.borrowChangeOther ?? prev?.borrowChangeOther ?? null) : null,
        timeInfo: ({
          eventType: timePack.eventType,
          lower: timePack.lower,
          lowerEra: timePack.lowerEra,
          upper: timePack.upper,
          upperEra: timePack.upperEra
        } ?? prev?.timeInfo ?? null),
        evidence : evidenceCsvDataUrl,
        recordedAt: prev?.recordedAt ?? new Date().toLocaleString()
      };

      if (editingVocabIndex !== null) {
        vocabData[editingVocabIndex] = vocabEntry;
      } else {
        vocabData.push(vocabEntry);
      }

      saveDraft();
      showPage(1);
      loadVocabList(vocabData);
    }
</script>

</html>